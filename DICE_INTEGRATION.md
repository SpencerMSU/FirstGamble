# Интеграция игры "Кости" с внешним сервисом

Этот файл описывает, как пользоваться единственным публичным REST-эндпоинтом для начисления очков за броски кубиков и какие требования предъявляются к данным. Вся внутренняя логика мини-приложения остаётся скрытой и не документируется здесь.

## Единственный эндпоинт в Swagger UI
В Swagger UI отображается только один метод — `POST /api/dice/award`. Все остальные маршруты скрыты из схемы, но продолжают работать внутри приложения.

### Авторизация
- Требуется служебный токен `ConServeAuthToken` из файла `tokens.txt`.
- Передавайте его в заголовке `X-ConServe-Auth` (или `X-Conserve-Auth`). Без него запрос вернёт `401 invalid conserve token`.

### Запрос
```json
{
  "Nick_Name": "Player_123",    // Игровой Nick_Name, если он привязан в кабинете (может отсутствовать)
  "dice_sum": 14                 // Сумма броска (для внешних запросов проверяется как бросок двух кубиков)
}
```

### Поведение
1. Токен проверяется по `ConServeAuthToken` из `tokens.txt`.
2. Ищется пользователь с привязанным `Nick_Name` (если он передан). Если связки нет — ответ `404 Nick_Name is not linked`.
3. Проверяется корректность суммы: для внешних запросов ожидается результат броска **двух** кубиков (диапазон 2–12).
4. Игроку начисляются очки, равные `dice_sum`. Баланс обновляется в Redis и попадает в лидерборд.

### Ответ
```json
{
  "ok": true,
  "user_id": 123456,
  "nick_name": "Player_123",
  "dice_sum": 14,
  "added_points": 14,
  "balance": 140
}
```

### Пример запроса
```bash
curl -X POST "https://api.firstgamble.ru/api/dice/award" \
  -H "Content-Type: application/json" \
  -H "X-ConServe-Auth: <ConServeAuthToken>" \
  -d '{
    "dice_sum": 14
  }'
```

Для прямых обращений на сервер можно использовать IP-адрес `5.129.243.45` вместо домена.

## Как связать Nick_Name
В профиле бота/мини-приложения должен быть установлен `Nick_Name` (кнопка в кабинете). Именно эта строка используется для поиска пользователя при вызове `/api/dice/award`.

## Проверки ошибок
- **401** — неверный или отсутствующий `ConServeToken`.
- **400 dice_sum out of range** — сумма не соответствует диапазону броска двух кубиков (2–12).
- **404 Nick_Name is not linked** — в базе нет пользователя с таким `Nick_Name`.

## Где смотреть документацию
Открывайте `/docs` — там будет только `POST /api/dice/award` с описанными выше полями.
