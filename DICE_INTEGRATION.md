# Интеграция игры "Кости" с внешним сервисом

Этот файл описывает, как работает начисление очков за игру в кости, как пользоваться единственным публичным REST-эндпоинтом и какие требования предъявляются к данным.

## Логика игры в мини-приложении
- Внутри мини-приложения можно бросить от 1 до 5 кубиков одним POST-запросом.
- Отдельный внутренний POST-запрос возвращает сумму броска и `Nick_Name`. Сумма должна быть не больше 12 — при превышении вернётся ошибка.
- При победе начисляются очки, равные сумме выпавших значений. Например, при сумме 8 за раунд игрок получит сразу 8 очков.
- Очки начисляются через `POST /api/add_point` с параметром `delta = <сумма кубиков>`, но этот внутренний вызов спрятан за интерфейсом игры.

## Единственный эндпоинт в Swagger UI
В Swagger UI отображается только один метод — `POST /api/dice/award`. Все остальные маршруты скрыты из схемы, но продолжают работать внутри приложения.

### Авторизация
- Требуется служебный токен `ConServeAuthToken` из файла `tokens.txt`.
- Передавайте его в заголовке `X-ConServe-Auth` (или `X-Conserve-Auth`). Без него запрос вернёт `401 invalid conserve token`.

### Запрос
```json
{
  "Nick_Name": "Player_123",     // Игровой Nick_Name, заранее привязанный к аккаунту в боте
  "dice_sum": 8,                 // Сумма броска (максимум 12, иначе ошибка)
  "dice_count": 3                // Количество кубиков: от 1 до 5 (по умолчанию 2)
}
```

### Поведение
1. Токен проверяется по `ConServeAuthToken` из `tokens.txt`.
2. Ищется пользователь с привязанным `Nick_Name`. Если связки нет — ответ `404 Nick_Name is not linked`.
3. Проверяется корректность суммы: она должна быть не меньше количества кубиков и не больше 12.
4. Игроку начисляются очки, равные `dice_sum`. Баланс обновляется в Redis и попадает в лидерборд.

### Ответ
```json
{
  "ok": true,
  "user_id": 123456,
  "nick_name": "Player_123",
  "dice_sum": 8,
  "dice_count": 2,
  "added_points": 8,
  "balance": 140
}
```

### Пример запроса
```bash
curl -X POST "https://api.firstgamble.ru/api/dice/award" \
  -H "Content-Type: application/json" \
  -H "X-ConServe-Auth: <ConServeAuthToken>" \
  -d '{
    "Nick_Name": "Player_123",
    "dice_sum": 8,
    "dice_count": 3
  }'
```

Для прямых обращений на сервер можно использовать IP-адрес `5.129.243.45` вместо домена.

## Как связать Nick_Name
В профиле бота/мини-приложения должен быть установлен `Nick_Name` (кнопка в кабинете). Именно эта строка используется для поиска пользователя при вызове `/api/dice/award`.

## Проверки ошибок
- **401** — неверный или отсутствующий `ConServeToken`.
- **400 dice_sum out of range** — сумма не соответствует количеству кубиков (разрешены только 1–5 кубов, максимум 12 по сумме).
- **404 Nick_Name is not linked** — в базе нет пользователя с таким `Nick_Name`.

## Где смотреть документацию
Открывайте `/docs` — там будет только `POST /api/dice/award` с описанными выше полями.
