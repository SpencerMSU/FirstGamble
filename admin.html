<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω–∫–∞ —Ä–æ–∑—ã–≥—Ä—ã—à–µ–π ‚Äî FirstClub</title>
  <style>
    :root{--bg:#0a0d12;--panel:#0d1117;--card:#111722;--stroke:rgba(255,255,255,.08);--blue:#3b82f6;--blue2:#1d4ed8;--text:#e6edf3;--muted:#98a2b3;--danger:#ef4444;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,var(--bg) 0%,#06080d 100%);color:var(--text);min-height:100vh;display:flex;justify-content:center;padding:16px;}
    .app{width:min(1100px,100%);background:var(--panel);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:16px;}
    h1,h2,h3{margin:0;color:var(--text);} h2{font-size:18px;} h3{font-size:16px;}
    .muted{color:var(--muted);font-size:13px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;} @media(max-width:860px){.grid{grid-template-columns:1fr;}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    input,button,select,textarea{padding:10px;border-radius:10px;border:1px solid var(--stroke);background:#0f1520;color:var(--text);font-weight:700;touch-action:manipulation;}
    button{cursor:pointer;background:linear-gradient(180deg,var(--blue),var(--blue2));border-color:rgba(59,130,246,.45);} button.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border-color:rgba(239,68,68,.45);} button.secondary{background:var(--card);color:var(--text);} button:disabled{opacity:.6;cursor:not-allowed;}
    table{width:100%;border-collapse:collapse;margin-top:10px;} th,td{border:1px solid var(--stroke);padding:8px;text-align:left;} th{background:#0f1624;}
    .hidden{display:none;}
    .tag{padding:4px 10px;border-radius:999px;background:#0f1624;border:1px solid var(--stroke);font-weight:800;}
    .error{color:#f87171;}
  </style>
</head>
<body>
  <div class="app">
    <div id="loginForm" class="hidden" style="display:flex; flex-direction:column; gap:12px; max-width:300px; margin:0 auto;">
      <h2 style="text-align:center;">–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</h2>
      <input id="admUser" placeholder="–õ–æ–≥–∏–Ω">
      <input id="admPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
      <button id="admLoginBtn">–í–æ–π—Ç–∏</button>
      <div id="loginError" class="error" style="text-align:center;"></div>
    </div>

    <div id="adminApp" class="hidden">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <div>
          <h1>–†–æ–∑—ã–≥—Ä—ã—à–∏ ‚Ä¢ Admin</h1>
          <div class="muted" id="adminUser"></div>
        </div>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center;">
            <h2>–ü—Ä–∏–∑—ã —Ä–æ–∑—ã–≥—Ä—ã—à–∞</h2>
            <div class="row" style="gap:6px;">
              <button id="publishPrizesBtn" class="secondary">–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–∑—ã</button>
              <button id="addPrizeBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </div>
          <div class="muted">–ü—Ä–∏–∑—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø–æ –ø–æ—Ä—è–¥–∫—É: –ø–µ—Ä–≤—ã–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π ‚Äî 1 –º–µ—Å—Ç–æ, –¥–∞–ª–µ–µ –ø–æ —Å–ø–∏—Å–∫—É.</div>
          <table id="prizeTable">
            <thead><tr><th>ID</th><th>–ú–µ—Å—Ç–æ</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center;">
            <h2>–ò—Ç–æ–≥–∏ —Ä–æ–∑—ã–≥—Ä—ã—à–∞</h2>
            <div class="row" style="gap:6px;">
              <button id="finishPayoutBtn" class="secondary">–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–¥–∞—á—É</button>
              <button id="drawBtn" class="danger">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏—Ç–æ–≥–∏</button>
            </div>
          </div>
          <div class="muted">–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –Ω–µ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–∑–∞.</div>
          <div id="winnersList" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>–ë–∞–ª–∞–Ω—Å –∏–≥—Ä–æ–∫–æ–≤</h2>
        <div class="row" style="margin-top:8px;">
          <input id="findNickname" placeholder="–ù–∏–∫–Ω–µ–π–º" style="min-width:220px;">
          <button id="findUserBtn">–ù–∞–π—Ç–∏</button>
          <span id="foundInfo" class="muted"></span>
        </div>
        <div class="row" style="margin-top:10px;">
          <input id="deltaPoints" type="number" placeholder="Œî –æ—á–∫–æ–≤ (–º–æ–∂–Ω–æ -)" style="width:200px;">
          <input id="newBalance" type="number" placeholder="–ò–ª–∏ –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å" style="width:200px;">
          <button id="saveBalanceBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div id="balanceStatus" class="muted" style="margin-top:8px;"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>–†–µ—Å—É—Ä—Å—ã RPG</h2>
        <div class="row" style="margin-top:8px;gap:8px;">
          <input id="resNickname" placeholder="–ù–∏–∫–Ω–µ–π–º" style="min-width:200px;">
          <select id="resType" style="min-width:140px;"></select>
          <input id="resAmount" type="number" min="1" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" style="width:160px;">
          <button id="grantResBtn">–í—ã–¥–∞—Ç—å</button>
        </div>
        <div id="resGrantStatus" class="muted" style="margin-top:8px;"></div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>–≠–∫–æ–Ω–æ–º–∏–∫–∞ RPG</h2>
        <div class="muted">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫—É—Ä—Å –æ–±–º–µ–Ω–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –±–∞–∑–æ–≤—ã–π –ö–î –¥–æ–±—ã—á–∏.</div>
        <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap;align-items:flex-end;">
          <label style="display:flex;flex-direction:column;gap:6px;min-width:180px;">
            <span class="muted">–ö—É—Ä—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ (X –∫ 1)</span>
            <input id="econRate" type="number" min="1" value="5" style="width:200px;">
          </label>
          <label style="display:flex;flex-direction:column;gap:6px;min-width:180px;">
            <span class="muted">–ë–∞–∑–æ–≤—ã–π –ö–î –¥–æ–±—ã—á–∏ (—Å–µ–∫)</span>
            <input id="econCd" type="number" min="30" value="300" style="width:200px;">
          </label>
          <button id="saveEconomyBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="reloadEconomyBtn" class="secondary">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div id="economyStatus" class="muted" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://api.firstgamble.ru";
    const qs = (id) => document.getElementById(id);
    const medalForPlace = (place) => ({1:'ü•á',2:'ü•à',3:'ü•â'}[place]||'');
    let prizesCache = [];
    let prizesVisible = false;
    const rpgResources = ['wood','stone','iron','silver','gold','crystal','mythril','relic','essence'];
    const econRateInput = qs('econRate');
    const econCdInput = qs('econCd');
    const economyStatus = qs('economyStatus');

    function ensureEditable(id){
      const el = qs(id);
      if(!el) return;
      const unlock = ()=>{ el.readOnly = false; el.disabled = false; };
      unlock();
      ['focus','mousedown','touchstart'].forEach(evt=>{
        el.addEventListener(evt, unlock, {passive:true});
      });
    }

    async function runAction(btn, action, onError){
      if(btn && btn.dataset.busy === '1') return;
      if(btn){ btn.dataset.busy='1'; btn.disabled=true; }
      try{
        await action();
      }catch(e){
        console.error('Admin action failed', e);
        if(typeof onError === 'function'){
          onError(e);
        }else{
          alert('–û—à–∏–±–∫–∞: ' + (e?.message || e));
        }
      }finally{
        if(btn){ btn.dataset.busy=''; btn.disabled=false; }
      }
    }

    async function api(path, method='GET', body=null){
      const opts = {method, headers:{'Content-Type':'application/json'}, credentials:'include'};
      if(body) opts.body = JSON.stringify(body);
      const res = await fetch(API_BASE + path, opts);
      if(res.status === 401){
        throw new Error('unauthorized');
      }
      if(!res.ok){
        let detail = '';
        try{
          const data = await res.json();
          detail = data?.detail || data?.error || '';
        }catch(_e){
          detail = await res.text();
        }
        const err = new Error(detail || 'request failed');
        err.code = detail || undefined;
        throw err;
      }
      return await res.json();
    }

    ['findNickname','deltaPoints','newBalance','resNickname','resAmount'].forEach(ensureEditable);

    function renderPrizes(items){
      const tbody = qs('prizeTable').querySelector('tbody');
      tbody.innerHTML = '';
      prizesCache = items || [];
      (items||[]).forEach((p, idx) => {
        const tr = document.createElement('tr');
        const place = p.order || idx + 1;
        const medal = medalForPlace(place);
        tr.innerHTML = `<td>${p.id}</td><td>${medal ? medal + ' ' : ''}${place} –º–µ—Å—Ç–æ</td><td>${p.name}</td>`;
        const actions = document.createElement('td');
        const edit = document.createElement('button');
        edit.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å';
        edit.className = 'secondary';
        edit.onclick = async ()=>{
          const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ', p.name)?.trim();
          if(!name || name === p.name) return;
          const res = await api(`/api/admin/raffle/prizes/${p.id}`,'PUT',{name});
          renderPrizes(res.items||[]);
        };
        const del = document.createElement('button');
        del.textContent = '–£–¥–∞–ª–∏—Ç—å';
        del.className = 'danger';
        del.onclick = async ()=>{
          if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–∑?')) return;
          const res = await api(`/api/admin/raffle/prizes/${p.id}`,'DELETE');
          renderPrizes(res.items||[]);
        };
        actions.append(edit, del);
        tr.appendChild(actions);
        tbody.appendChild(tr);
      });
    }

    function renderWinners(items){
      const root = qs('winnersList');
      root.innerHTML = '';
      if(!items || items.length===0){
        root.innerHTML = '<div class="muted">–ò—Ç–æ–≥–∏ –µ—â—ë –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã.</div>';
        return;
      }
      items.forEach(w=>{
        const row = document.createElement('div');
        row.className = 'row';
        const ticket = w.ticket_no || w.ticket;
        const username = w.winner_username ? '@'+w.winner_username : (w.user_name || w.user_id);
        const prize = prizesCache.find(p=>p.id===w.prize_id);
        const place = prize?.order || w.prize_order || '?';
        const medal = medalForPlace(prize?.order || w.prize_order);
        row.innerHTML = `<span class="tag">${medal?medal+' ':''}${place} –º–µ—Å—Ç–æ</span><span class="tag">–ë–∏–ª–µ—Ç ${ticket||'?'}</span><span class="tag">${username || ''}</span>`;
        root.appendChild(row);
      });
    }

    function updatePublishBtn(){
      const btn = qs('publishPrizesBtn');
      if(!btn) return;
      btn.textContent = prizesVisible ? '–°–∫—Ä—ã—Ç—å –ø—Ä–∏–∑—ã' : '–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–∑—ã';
      btn.classList.toggle('secondary', prizesVisible);
    }

    async function loadPrizes(){
      const res = await api('/api/admin/raffle/prizes');
      prizesVisible = !!res.prizes_visible;
      updatePublishBtn();
      renderPrizes(res.items||[]);
    }

    async function loadWinners(){
      if(!prizesCache.length){
        await loadPrizes();
      }
      const res = await api('/api/admin/raffle/winners');
      renderWinners(res.items||[]);
      if(res.status === 'closed' && (!res.items || res.items.length === 0)){
        qs('winnersList').innerHTML = '<div class="muted">–í—ã–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –∏—Ç–æ–≥–∏ —Å–∫—Ä—ã—Ç—ã –¥–æ –Ω–æ–≤–æ–≥–æ —Ä–æ–∑—ã–≥—Ä—ã—à–∞.</div>';
      }
    }

    async function loadEconomy(){
      economyStatus.textContent = '';
      try{
        const res = await api('/api/admin/rpg/economy');
        const econ = res?.economy || {};
        if(econRateInput) econRateInput.value = econ.convert_rate ?? '';
        if(econCdInput) econCdInput.value = econ.base_cd ?? '';
        economyStatus.textContent = `–¢–µ–∫—É—â–∏–π –∫—É—Ä—Å: ${econ.convert_rate || '?'} –∫ 1, –±–∞–∑–æ–≤—ã–π –ö–î: ${econ.base_cd || '?'} —Å–µ–∫.`;
      }catch(e){
        economyStatus.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —ç–∫–æ–Ω–æ–º–∏–∫—É: ' + (e.message || e);
      }
    }

    async function saveEconomy(){
      economyStatus.textContent = '';
      const payload = {
        convert_rate: Number(econRateInput.value || 0) || null,
        base_cd: Number(econCdInput.value || 0) || null,
      };
      try{
        const res = await api('/api/admin/rpg/economy','POST',payload);
        const econ = res?.economy || {};
        economyStatus.textContent = `–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ö—É—Ä—Å: ${econ.convert_rate} –∫ 1, –±–∞–∑–æ–≤—ã–π –ö–î: ${econ.base_cd} —Å–µ–∫.`;
      }catch(e){
        economyStatus.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (e.message || e);
      }
    }

    qs('addPrizeBtn').addEventListener('click', ()=>runAction(qs('addPrizeBtn'), async ()=>{
      console.log('click add prize');
      const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞');
      if(!name) return;
      await api('/api/admin/raffle/prizes','POST',{name});
      await loadPrizes();
    }));

    qs('publishPrizesBtn').addEventListener('click', ()=>runAction(qs('publishPrizesBtn'), async ()=>{
      const next = !prizesVisible;
      await api('/api/admin/raffle/publish_prizes','POST',{visible: next});
      prizesVisible = next;
      updatePublishBtn();
      alert(next ? '–ü—Ä–∏–∑—ã –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –Ω–∞ –ø—É–±–ª–∏—á–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ.' : '–ü—Ä–∏–∑—ã —Å–∫—Ä—ã—Ç—ã —Å –ø—É–±–ª–∏—á–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.');
    }));

    qs('drawBtn').addEventListener('click', ()=>runAction(qs('drawBtn'), async ()=>{
      console.log('click draw results');
      if(!confirm('–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏—Ç–æ–≥–∏?')) return;
      const res = await api('/api/admin/raffle/draw','POST',{force:false});
      renderWinners(res.items||[]);
    }, (e)=>{
      const msg = e?.code === 'no_prizes'
        ? '–ù–µ–ª—å–∑—è —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏—Ç–æ–≥–∏: —Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∏–∑'
        : (e?.message || e);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ä–æ–∑—ã–≥—Ä—ã—à: '+ msg);
    }));

    qs('finishPayoutBtn').addEventListener('click', ()=>runAction(qs('finishPayoutBtn'), async ()=>{
      console.log('click finish payout');
      if(!confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã–¥–∞—á—É –∏ —Å–∫—Ä—ã—Ç—å –∏—Ç–æ–≥–∏ —Å –ø—É–±–ª–∏—á–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã?')) return;
      await api('/api/admin/raffle/finish_payout','POST');
      alert('–í—ã–¥–∞—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø—É–±–ª–∏—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–Ω–æ–≤–∞ –≤ —Ä–µ–∂–∏–º–µ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏.');
      await loadWinners();
    }));

    qs('findUserBtn').addEventListener('click', ()=>runAction(qs('findUserBtn'), async ()=>{
      console.log('click find user');
      qs('foundInfo').textContent = '';
      qs('balanceStatus').textContent = '';
      const nickname = qs('findNickname').value.trim();
      if(!nickname) return;
      const res = await api('/api/admin/users/by_nickname','POST',{nickname});
      if(!res.ok){
        throw new Error(res.error || 'User not found');
      }
      qs('findUserBtn').dataset.uid = res.user_id;
      qs('foundInfo').textContent = `user_id: ${res.user_id}, –±–∞–ª–∞–Ω—Å: ${res.balance}`;
    }, (e)=>{
      qs('findUserBtn').dataset.uid = '';
      const errText = (e?.code === 'not found' || /not found/i.test(e?.message||''))
        ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–∏–∫–Ω–µ–π–º–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω'
        : '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + (e?.message || e);
      qs('foundInfo').textContent = errText;
    }));

    qs('saveBalanceBtn').addEventListener('click', ()=>runAction(qs('saveBalanceBtn'), async ()=>{
      console.log('click save balance');
      const uid = Number(qs('findUserBtn').dataset.uid||0);
      const nickname = qs('findNickname').value.trim();
      const points_delta = qs('deltaPoints').value ? Number(qs('deltaPoints').value) : null;
      const new_balance = qs('newBalance').value ? Number(qs('newBalance').value) : null;
      if(!uid && !nickname){
        qs('balanceStatus').textContent = '–°–Ω–∞—á–∞–ª–∞ –Ω–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–∏–∫–Ω–µ–π–º—É.';
        return;
      }
      const res = await api('/api/admin/users/set_points','POST',{user_id:uid||undefined,nickname,points_delta,new_balance});
      qs('balanceStatus').textContent = `–ù–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${res.balance}`;
    }, (e)=>{
      qs('balanceStatus').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: '+(e?.message||e);
    }));

    const resSelect = qs('resType');
    rpgResources.forEach(r=>{
      const opt = document.createElement('option');
      opt.value = r;
      opt.textContent = r;
      resSelect.appendChild(opt);
    });

    qs('grantResBtn').addEventListener('click', ()=>runAction(qs('grantResBtn'), async ()=>{
      const nickname = qs('resNickname').value.trim();
      const resource = qs('resType').value;
      const amount = Number(qs('resAmount').value || 0);
      qs('resGrantStatus').textContent = '';
      if(!nickname){
        qs('resGrantStatus').textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º –∏–≥—Ä–æ–∫–∞.';
        return;
      }
      if(!resource){
        qs('resGrantStatus').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—É—Ä—Å.';
        return;
      }
      if(!amount || amount <= 0){
        qs('resGrantStatus').textContent = '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è.';
        return;
      }
      const res = await api('/api/admin/rpg/grant_resources','POST',{nickname,resource,amount});
      const total = res?.resources?.[resource] ?? amount;
      qs('resGrantStatus').textContent = `–í—ã–¥–∞–Ω–æ ${amount} ${resource}. –¢–µ–ø–µ—Ä—å —É –∏–≥—Ä–æ–∫–∞: ${total}.`;
    }, (e)=>{
      qs('resGrantStatus').textContent = '–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏: '+ (e?.message||e);
    }));
    qs('saveEconomyBtn').addEventListener('click', saveEconomy);
    qs('reloadEconomyBtn').addEventListener('click', loadEconomy);
    qs('adminUser').textContent = '–î–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç –∏–∑ WebApp';

    function showLogin(){
      qs('loginForm').style.display='flex';
      qs('adminApp').style.display='none';
    }

    function showAdmin(){
      qs('loginForm').style.display='none';
      qs('adminApp').style.display='block';
    }

    async function doLogin(){
      const username = qs('admUser').value.trim();
      const password = qs('admPass').value;
      const errEl = qs('loginError');
      errEl.textContent = '';
      if(!username) return;

      const btn = qs('admLoginBtn');
      btn.disabled = true;

      try{
        const res = await fetch(API_BASE + "/api/admin/login", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          credentials: "include",
          body: JSON.stringify({username, password}),
        });

        if(!res.ok){
          let msg = "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏";
          try{ const d=await res.json(); msg=d.detail||d.error||msg; }catch(e){}
          throw new Error(msg);
        }

        showAdmin();
        await initAdmin();
      }catch(e){
        errEl.textContent = e.message || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
      }finally{
        btn.disabled = false;
      }
    }

    qs('admLoginBtn').addEventListener('click', doLogin);

    async function initAdmin(){
      try{
        await loadPrizes();
        await loadWinners();
        await loadEconomy();
        showAdmin();
      }catch(e){
        if(e.message === 'unauthorized'){
          showLogin();
        }else{
          console.error("Init error", e);
          // showAdmin(); // Try to show admin anyway? No, probably login.
          // If 401 happened during loadPrizes, it throws unauthorized
        }
      }
    }

    (async()=>{
      await initAdmin();
    })();
  </script>
</body>
</html>
