<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админка розыгрышей — FirstClub</title>
  <style>
    :root{--bg:#0a0d12;--panel:#0d1117;--card:#111722;--stroke:rgba(255,255,255,.08);--blue:#3b82f6;--blue2:#1d4ed8;--text:#e6edf3;--muted:#98a2b3;--danger:#ef4444;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,var(--bg) 0%,#06080d 100%);color:var(--text);min-height:100vh;display:flex;justify-content:center;padding:16px;}
    .app{width:min(1100px,100%);background:var(--panel);border:1px solid var(--stroke);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:16px;}
    h1,h2,h3{margin:0;color:var(--text);} h2{font-size:18px;} h3{font-size:16px;}
    .muted{color:var(--muted);font-size:13px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;} @media(max-width:860px){.grid{grid-template-columns:1fr;}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:12px;padding:12px;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    input,button,select,textarea{padding:10px;border-radius:10px;border:1px solid var(--stroke);background:#0f1520;color:var(--text);font-weight:700;}
    button{cursor:pointer;background:linear-gradient(180deg,var(--blue),var(--blue2));border-color:rgba(59,130,246,.45);} button.danger{background:linear-gradient(180deg,#ef4444,#b91c1c);border-color:rgba(239,68,68,.45);} button.secondary{background:var(--card);color:var(--text);}
    table{width:100%;border-collapse:collapse;margin-top:10px;} th,td{border:1px solid var(--stroke);padding:8px;text-align:left;} th{background:#0f1624;}
    .hidden{display:none;}
    .tag{padding:4px 10px;border-radius:999px;background:#0f1624;border:1px solid var(--stroke);font-weight:800;}
    .error{color:#f87171;}
  </style>
</head>
<body>
  <div class="app">
    <div id="adminApp">
      <div class="row" style="justify-content:space-between;align-items:center;">
        <div>
          <h1>Розыгрыши • Admin</h1>
          <div class="muted" id="adminUser"></div>
        </div>
      </div>

      <div class="grid" style="margin-top:12px;">
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center;">
            <h2>Призы розыгрыша</h2>
            <button id="addPrizeBtn">Добавить</button>
          </div>
          <div class="muted">Укажите порядок для контроля выпадения (меньше — выше).</div>
          <table id="prizeTable">
            <thead><tr><th>ID</th><th>Название</th><th>Описание</th><th>Порядок</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center;">
            <h2>Итоги розыгрыша</h2>
            <div class="row" style="gap:6px;">
              <button id="finishPayoutBtn" class="secondary">Завершить выдачу</button>
              <button id="drawBtn" class="danger">Сформировать итоги</button>
            </div>
          </div>
          <div class="muted">Каждый пользователь получает не больше одного приза.</div>
          <div id="winnersList" style="margin-top:10px;display:flex;flex-direction:column;gap:8px;"></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px;">
        <h2>Баланс игроков</h2>
        <div class="row" style="margin-top:8px;">
          <input id="findNickname" placeholder="Никнейм" style="min-width:220px;">
          <button id="findUserBtn">Найти</button>
          <span id="foundInfo" class="muted"></span>
        </div>
        <div class="row" style="margin-top:10px;">
          <input id="deltaPoints" type="number" placeholder="Δ очков (можно -)" style="width:200px;">
          <input id="newBalance" type="number" placeholder="Или новый баланс" style="width:200px;">
          <button id="saveBalanceBtn">Сохранить</button>
        </div>
        <div id="balanceStatus" class="muted" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "https://api.firstgamble.ru";
    const qs = (id) => document.getElementById(id);

    async function api(path, method='GET', body=null){
      const opts = {method, headers:{'Content-Type':'application/json'}, credentials:'include'};
      if(body) opts.body = JSON.stringify(body);
      const res = await fetch(API_BASE + path, opts);
      if(res.status === 401){
        window.location.href = "/";
        throw new Error('unauthorized');
      }
      if(!res.ok){
        let detail = '';
        try{
          const data = await res.json();
          detail = data?.detail || data?.error || '';
        }catch(_e){
          detail = await res.text();
        }
        const err = new Error(detail || 'request failed');
        err.code = detail || undefined;
        throw err;
      }
      return await res.json();
    }

    ['findNickname','deltaPoints','newBalance'].forEach(id=>{
      const el = qs(id);
      if(el){
        el.removeAttribute('readonly');
        el.removeAttribute('disabled');
      }
    });

    function renderPrizes(items){
      const tbody = qs('prizeTable').querySelector('tbody');
      tbody.innerHTML = '';
      (items||[]).forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.id}</td><td>${p.name}</td><td>${p.description||''}</td><td>${p.order||0}</td>`;
        const actions = document.createElement('td');
        const edit = document.createElement('button');
        edit.textContent = 'Изменить';
        edit.className = 'secondary';
        edit.onclick = async ()=>{
          const name = prompt('Название', p.name)||p.name;
          const description = prompt('Описание', p.description||'')||'';
          const order = Number(prompt('Порядок', p.order||0) || p.order || 0);
          const res = await api(`/api/admin/raffle/prizes/${p.id}`,'PUT',{name,description,order});
          renderPrizes(res.items||[]);
        };
        const del = document.createElement('button');
        del.textContent = 'Удалить';
        del.className = 'danger';
        del.onclick = async ()=>{
          if(!confirm('Удалить приз?')) return;
          const res = await api(`/api/admin/raffle/prizes/${p.id}`,'DELETE');
          renderPrizes(res.items||[]);
        };
        actions.append(edit, del);
        tr.appendChild(actions);
        tbody.appendChild(tr);
      });
    }

    function renderWinners(items){
      const root = qs('winnersList');
      root.innerHTML = '';
      if(!items || items.length===0){
        root.innerHTML = '<div class="muted">Итоги ещё не сформированы.</div>';
        return;
      }
      items.forEach(w=>{
        const row = document.createElement('div');
        row.className = 'row';
        const ticket = w.ticket_no || w.ticket;
        const username = w.user_name || w.user_id;
        row.innerHTML = `<span class="tag">Приз #${w.prize_id}</span><span class="tag">Билет ${ticket||'?'}</span><span class="tag">${username || ''}</span>`;
        root.appendChild(row);
      });
    }

    async function loadPrizes(){
      const res = await api('/api/admin/raffle/prizes');
      renderPrizes(res.items||[]);
    }

    async function loadWinners(){
      const res = await api('/api/admin/raffle/winners');
      renderWinners(res.items||[]);
    }

    qs('addPrizeBtn').onclick = async ()=>{
      const name = prompt('Название приза');
      if(!name) return;
      const description = prompt('Описание') || '';
      const order = Number(prompt('Порядок (число)') || 0);
      await api('/api/admin/raffle/prizes','POST',{name,description,order});
      await loadPrizes();
    };

    qs('drawBtn').onclick = async ()=>{
      if(!confirm('Сформировать итоги?')) return;
      try{
        const res = await api('/api/admin/raffle/draw','POST',{force:false});
        renderWinners(res.items||[]);
      }catch(e){
        const msg = e.code === 'no_prizes'
          ? 'Нельзя сформировать итоги: сначала добавьте хотя бы один приз'
          : e.message;
        alert('Не удалось провести розыгрыш: '+ msg);
      }
    };

    qs('finishPayoutBtn').onclick = async ()=>{
      if(!confirm('Завершить выдачу и скрыть итоги с публичной страницы?')) return;
      try{
        await api('/api/admin/raffle/finish_payout','POST');
        alert('Выдача завершена, публичная страница снова в режиме подготовки.');
      }catch(e){
        alert('Не удалось завершить выдачу: '+ e.message);
      }
    };

      qs('findUserBtn').onclick = async ()=>{
        qs('foundInfo').textContent = '';
        qs('balanceStatus').textContent = '';
      const nickname = qs('findNickname').value.trim();
      if(!nickname) return;
      try{
        const res = await api('/api/admin/users/by_nickname','POST',{nickname});
        qs('findUserBtn').dataset.uid = res.user_id;
        qs('foundInfo').textContent = `user_id: ${res.user_id}, баланс: ${res.balance}`;
      }catch(e){
        qs('findUserBtn').dataset.uid = '';
        if(e.code === 'not found'){
          qs('foundInfo').textContent = 'Пользователь с таким никнеймом не найден';
        }else{
          qs('foundInfo').textContent = 'Ошибка запроса: ' + (e.message || e);
        }
      }
    };

    qs('saveBalanceBtn').onclick = async ()=>{
      const uid = Number(qs('findUserBtn').dataset.uid||0);
      const nickname = qs('findNickname').value.trim();
      const points_delta = qs('deltaPoints').value ? Number(qs('deltaPoints').value) : null;
      const new_balance = qs('newBalance').value ? Number(qs('newBalance').value) : null;
      if(!uid && !nickname){
        qs('balanceStatus').textContent = 'Сначала найдите пользователя по никнейму.';
        return;
      }
      try{
        const res = await api('/api/admin/users/set_points','POST',{user_id:uid||undefined,nickname,points_delta,new_balance});
        qs('balanceStatus').textContent = `Новый баланс: ${res.balance}`;
      }catch(e){
        qs('balanceStatus').textContent = 'Не удалось сохранить: '+e.message;
      }
    };
    qs('adminUser').textContent = 'Доступ открыт из WebApp';
    loadPrizes();
    loadWinners();
  </script>
</body>
</html>
