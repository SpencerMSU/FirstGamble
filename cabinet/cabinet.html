<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî FirstClub</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="/webapp_guard.js"></script>
<style>
:root{
  --bg:#0a0d12;--bg2:#0e1117;--panel:#0d1117;--card:#111722;--card2:#0f1520;
  --stroke:rgba(255,255,255,.06);--stroke2:rgba(100,160,255,.25);
  --blue:#3b82f6;--blue2:#1d4ed8;--text:#e6edf3;--muted:#98a2b3;
  --green:#22c55e;--red:#ef4444;--amber:#f59e0b;
  --shadow:0 0 0 1px var(--stroke),0 8px 30px rgba(0,0,0,.6);
  --radius:18px;
}
html[data-theme="light"]{
  --bg:#f4f7fb;--bg2:#eef2f7;--panel:#fff;--card:#fff;--card2:#f6f8fb;
  --stroke:rgba(10,20,40,.08);--stroke2:rgba(59,130,246,.35);
  --blue:#2563eb;--blue2:#1d4ed8;--text:#0b1220;--muted:#52607a;
  --shadow:0 0 0 1px var(--stroke),0 10px 26px rgba(10,20,40,.08);
} html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-overflow-scrolling:auto;touch-action:manipulation;} *{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
  background:
    radial-gradient(1000px 600px at 10% -10%, rgba(59,130,246,.28), transparent 60%),
    radial-gradient(800px 500px at 110% 0%, rgba(29,78,216,.22), transparent 55%),
    linear-gradient(180deg,var(--bg2) 0%,var(--bg) 100%);
  min-height:100vh;display:flex;justify-content:center;padding:16px;
}
.app{
  width:min(1000px,100%);
  border:1px solid var(--stroke);border-radius:20px;box-shadow:var(--shadow);padding:14px;
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
  height:100%;overflow-y:auto;overscroll-behavior:none;
}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px 14px;gap:10px;}
.title{display:flex;flex-direction:column;gap:2px;align-items:center;flex:1;}
.title h1{margin:0;font-size:20px;font-weight:800;}
.title span{font-size:12px;color:var(--muted);}
.back{
  display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  border:1px solid var(--stroke);color:var(--text);text-decoration:none;font-weight:700;font-size:14px;cursor:pointer;transition:.15s ease;
}
.back:hover{border-color:var(--stroke2);transform:translateY(-1px);}
.balance-pill{
  display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  border:1px solid var(--stroke);font-weight:800;font-size:14px;min-width:88px;justify-content:center;
}
.section{background:linear-gradient(180deg,var(--panel),transparent);border:1px solid var(--stroke);border-radius:var(--radius);padding:12px;margin-bottom:12px;}
.tabs{display:flex;gap:8px;flex-wrap:wrap;}
.tab{
  padding:7px 10px;border-radius:10px;border:1px solid var(--stroke);
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  font-weight:800;font-size:12px;cursor:pointer;user-select:none;transition:.15s;
}
.tab.active{border-color:var(--stroke2);box-shadow:0 0 0 2px rgba(59,130,246,.12) inset;}
.bigbtn{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke2);cursor:pointer;
  background:linear-gradient(180deg,var(--blue) 0%,var(--blue2) 100%);color:white;font-weight:900;font-size:15px;
  display:flex;align-items:center;justify-content:center;gap:8px;transition:.15s;
}
.bigbtn:disabled{opacity:.6;cursor:not-allowed;filter:saturate(.5);}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
@media (max-width:720px){.grid2{grid-template-columns:1fr;}}
.res-card{
  border:1px solid var(--stroke);border-radius:12px;padding:10px;background:linear-gradient(180deg,var(--card),var(--card2));
  display:flex;flex-direction:column;gap:6px;
}
.res-row{display:flex;justify-content:space-between;align-items:center;font-weight:800;}
.res-sub{font-size:12px;color:var(--muted);font-weight:700;}
.bar{height:8px;border-radius:999px;background:rgba(255,255,255,.06);overflow:hidden;border:1px solid var(--stroke);}
.bar > div{height:100%;background:linear-gradient(90deg,var(--blue),var(--blue2));width:0%;}
.list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
@media (max-width:720px){.list{grid-template-columns:1fr;}}
.item{
  border:1px solid var(--stroke);border-radius:12px;padding:10px;background:linear-gradient(180deg,var(--card),var(--card2));
  display:flex;flex-direction:column;gap:6px;min-height:110px;
}
.item h4{margin:0;font-size:14px;font-weight:900;}
.item .desc{font-size:12px;color:var(--muted);font-weight:700;}
.cost{font-size:12px;font-weight:800;color:var(--text);}
.req{font-size:12px;color:var(--muted);}
.buybtn{
  margin-top:auto;padding:8px 10px;border-radius:10px;border:1px solid var(--stroke2);
  background:linear-gradient(180deg,var(--blue) 0%,var(--blue2) 100%);color:white;font-weight:900;font-size:12px;cursor:pointer;
}
.buybtn:disabled{opacity:.5;cursor:not-allowed;}
.note{font-size:12px;color:var(--muted);margin-top:6px;}
.hidden{display:none!important;}
.container,.content{height:100%;overflow-y:auto;overscroll-behavior:none;}</style>
<style>
/* –¥–æ–ø. —Å—Ç–∏–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞–±–∏–Ω–µ—Ç–∞ */
.ticket-grid {
  display:grid;
  grid-template-columns:repeat(6, minmax(0,1fr));
  gap:8px;
}
@media (max-width:900px) {
  .ticket-grid { grid-template-columns:repeat(4,minmax(0,1fr)); }
}
@media (max-width:560px) {
  .ticket-grid { grid-template-columns:repeat(3,minmax(0,1fr)); }
}
.ticket-chip {
  border:1px solid var(--stroke2);
  background:linear-gradient(180deg,var(--card),var(--card2));
  border-radius:10px;
  padding:10px 8px;
  text-align:center;
  font-weight:900;
  font-size:12px;
}
.inline-row {
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
}
.pill {
  padding:6px 10px; border-radius:999px; border:1px solid var(--stroke);
  background:linear-gradient(180deg,var(--card),var(--card2)); font-weight:800; font-size:12px;
}
.profile-block {display:flex;flex-direction:column;gap:6px;margin-top:10px;font-weight:800;}
.profile-block .muted {color:var(--muted);font-weight:700;font-size:13px;}
.profile-action {display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px dashed var(--stroke2);background:linear-gradient(180deg,var(--card),var(--card2));font-weight:800;font-size:12px;color:var(--text);cursor:pointer;max-width:fit-content;transition:.15s;}
.profile-action:hover{border-style:solid;}
.profile-subtext{font-size:12px;color:var(--muted);}
.ach-grid{display:grid;grid-template-columns:1fr;gap:10px;}
.ach-item{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--stroke);border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
.ach-info{flex:1;}
.ach-info h4{margin:0;font-size:14px;font-weight:900;}
.ach-info p{margin:4px 0 0;font-size:12px;color:var(--muted);}
.ach-status{font-size:12px;font-weight:800;padding:6px 10px;border-radius:10px;border:1px solid var(--stroke2);background:var(--panel);}
.ach-status.locked{color:var(--muted);border-style:dashed;}
.ach-status.claimable{background:linear-gradient(180deg,var(--blue),var(--blue2));color:white;cursor:pointer;box-shadow:0 4px 12px rgba(37,99,235,.4);}
.ach-status.claimed{color:var(--green);border-color:var(--green);background:rgba(34,197,94,0.1);}
</style>
</head>
<body>
<div class="app">
  <header>
    <a class="back" href="/">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="title">
      <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
      <span>–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏ –±–∏–ª–µ—Ç—ã</span>
    </div>
    <div class="balance-pill"><span>ü™ô</span><span id="balanceValue">0</span></div>
  </header>

  <div class="tabs" style="margin-bottom:12px;justify-content:center;">
    <div class="tab active" data-tab="profile">–ü—Ä–æ—Ñ–∏–ª—å</div>
    <div class="tab" data-tab="achievements">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
  </div>

  <div id="tab-profile">
    <section class="section">
      <div class="inline-row">
        <div class="pill">Telegram ID: <span id="tgid">‚Äî</span></div>
        <div class="pill">–ë–∏–ª–µ—Ç–æ–≤: <span id="ticketCount">0</span></div>
      </div>
      <div class="profile-block">
        <div>–ù–∏–∫–Ω–µ–π–º: <b id="profileName">‚Äî</b></div>
        <div class="muted">Telegram: <span id="profileUsername">‚Äî</span></div>
        <button class="profile-action" id="gameNickBtn" type="button">–ò–≥—Ä–æ–≤–æ–π Nick_Name: <span id="gameNickValue">–¥–æ–±–∞–≤–∏—Ç—å</span></button>
        <div class="profile-subtext">–ù—É–∂–µ–Ω –¥–ª—è —Ç–µ—Å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –∏–≥—Ä—ã –∏ –±–æ—Ç–∞.</div>
        <div class="muted">ID: <span id="profileTgId">‚Äî</span></div>
      </div>
    </section>

    <section class="section">
      <h3 style="margin:0 0 8px;font-size:16px;font-weight:900;">–¢–≤–æ–∏ –±–∏–ª–µ—Ç—ã</h3>
      <div id="ticketGrid" class="ticket-grid"></div>
      <div id="emptyNote" class="note" style="margin-top:8px;">–ë–∏–ª–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ö—É–ø–∏ –ø–µ—Ä–≤—ã–π!</div>
      <a class="bigbtn" style="margin-top:12px;" href="/shop">–ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω</a>
    </section>
  </div>

  <div id="tab-achievements" style="display:none;">
    <section class="section">
      <h3 style="margin:0 0 8px;font-size:16px;font-weight:900;">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h3>

      <!-- Sub-tabs for games -->
      <div class="tabs" style="margin-bottom:12px; gap:4px;">
        <div class="tab subtab active" data-subtab="all">–í—Å–µ</div>
        <div class="tab subtab" data-subtab="general">–û–±—â–∏–µ</div>
        <div class="tab subtab" data-subtab="dice">Dice</div>
        <div class="tab subtab" data-subtab="slot">Slots</div>
        <div class="tab subtab" data-subtab="bj">Blackjack</div>
        <div class="tab subtab" data-subtab="stack">Stack</div>
        <div class="tab subtab" data-subtab="runner">Runner</div>
        <div class="tab subtab" data-subtab="pulse">Pulse</div>
        <div class="tab subtab" data-subtab="doodle">Doodle</div>
      </div>

      <div id="achievementsList" class="ach-grid">
         <div style="text-align:center;color:var(--muted);padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>
    </section>
  </div>
</div>

<script>

const tgInstance = initTelegramGuard();

let uid = null;

function setTgIdLabel(value){
  document.getElementById("tgid").textContent = value || "‚Äî";
}

function getTgUserId(){
  try{ return tg?.initDataUnsafe?.user?.id || null; }catch(e){ return null; }
}

try{
  uid = new URLSearchParams(location.search).get("uid") || getTgUserId();
}catch(e){
  uid = getTgUserId();
}
if(uid) setTgIdLabel(uid);


let balance = 0;
let tickets = [];
let profileData = null;

function setBalance(v){
  balance = v||0;
  document.getElementById("balanceValue").textContent = balance;
}

function renderProfile(){
  const nameEl = document.getElementById("profileName");
  const userEl = document.getElementById("profileUsername");
  const tgIdEl = document.getElementById("profileTgId");
  const gameNickEl = document.getElementById("gameNickValue");

  const name = (profileData?.name || "").trim();
  const username = (profileData?.username || "").trim();
  const tgId = profileData?.tg_id || profileData?.user_id || "‚Äî";

  nameEl.textContent = name || "‚Äî";
  userEl.textContent = username ? `@${username.replace(/^@+/, "")}` : "‚Äî";
  gameNickEl.textContent = (profileData?.nick_name || "").trim() || "–¥–æ–±–∞–≤–∏—Ç—å";
  tgIdEl.textContent = tgId;
  if(tgId) setTgIdLabel(tgId);
}

async function promptGameNick(){
  const current = (profileData?.nick_name || "").trim();
  const next = prompt("–£–∫–∞–∂–∏ —Å–≤–æ–π –∏–≥—Ä–æ–≤–æ–π Nick_Name", current || "Nick_Name");
  if(next === null) return;
  const value = (next || "").trim();
  if(!value){
    tg?.showAlert?.("Nick_Name –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
    return;
  }
  const res = await apiPost("/api/profile", { Nick_Name: value });
  if(!res || !res.ok){
    const msg = res?.error || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å Nick_Name";
    tg?.showAlert?.(msg);
    return;
  }
  profileData = profileData || {};
  profileData.nick_name = value;
  renderProfile();
  tg?.showPopup?.({message: "Nick_Name –æ–±–Ω–æ–≤–ª—ë–Ω"});
}

function renderTickets(){
  const grid=document.getElementById("ticketGrid");
  const empty=document.getElementById("emptyNote");
  const count=document.getElementById("ticketCount");
  grid.innerHTML="";
  count.textContent = tickets.length;

  if(!tickets.length){
    empty.style.display="block";
    return;
  }
  empty.style.display="none";

  tickets.forEach(t=>{
    const el=document.createElement("div");
    el.className="ticket-chip";
    el.textContent = "#"+t;
    grid.appendChild(el);
  });
}

async function loadCabinet(){
  const cab = await apiGet(`/api/cabinet?user_id=${uid}`);
  if(!cab.ok){
    const msg = cab.error || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–±–∏–Ω–µ—Ç–∞";
    const empty = document.getElementById("emptyNote");
    empty.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${msg}`;
    empty.style.display = "block";
    document.getElementById("ticketGrid").innerHTML = "";
    return;
  }
  setTgIdLabel(cab.user_id);
  setBalance(cab.balance);
  tickets = cab.tickets || [];
  renderTickets();
}

async function loadProfile(){
  const prof = await fetchProfile();
  if(prof && prof.ok){
    profileData = prof;
    renderProfile();
  }
}

(async function main(){
  if(!tgInstance) return;
  await ensureNicknameOrRedirect(uid);
  await loadProfile();
  if(uid){
    loadCabinet();
  }else{
    setTgIdLabel("–Ω–µ—Ç TG id");
  }
})();

document.getElementById("gameNickBtn")?.addEventListener("click", promptGameNick);

// Tabs
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t => {
  t.onclick = () => {
    tabs.forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    const target = t.dataset.tab;
    document.getElementById('tab-profile').style.display = target === 'profile' ? 'block' : 'none';
    document.getElementById('tab-achievements').style.display = target === 'achievements' ? 'block' : 'none';
    if(target === 'achievements') loadAchievements();
  };
});

let allAchievements = [];
let currentSubTab = 'all';

// Init subtabs
const subtabs = document.querySelectorAll('.subtab');
subtabs.forEach(t => {
  t.onclick = () => {
    subtabs.forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    currentSubTab = t.dataset.subtab;
    renderAchievements(allAchievements);
  };
});

async function loadAchievements(){
  const list = document.getElementById('achievementsList');
  try{
    const res = await apiGet('/api/achievements');
    if(!res.ok){
      list.innerHTML = `<div style="color:var(--red);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>`;
      return;
    }
    allAchievements = res.items || [];
    renderAchievements(allAchievements);
  }catch(e){
    list.innerHTML = `<div style="color:var(--red);">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>`;
  }
}

function renderAchievements(items){
  const list = document.getElementById('achievementsList');
  list.innerHTML = '';

  const filtered = items.filter(i => {
    if(currentSubTab === 'all') return true;
    return (i.game || 'general') === currentSubTab;
  });

  if(!filtered || !filtered.length){
    list.innerHTML = `<div style="text-align:center;color:var(--muted);">–ù–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>`;
    return;
  }

  filtered.forEach(item => {
    const el = document.createElement('div');
    el.className = 'ach-item';

    let btnHtml = '';
    if(item.is_claimed){
      btnHtml = `<div class="ach-status claimed">–ü–æ–ª—É—á–µ–Ω–æ</div>`;
    } else if(item.is_unlocked){
      btnHtml = `<div class="ach-status claimable" onclick="claimAchievement('${item.id}')">–ó–∞–±—Ä–∞—Ç—å ${item.reward}</div>`;
    } else {
      const p = Math.min(100, Math.round((item.progress / item.target) * 100)) || 0;
      btnHtml = `<div class="ach-status locked">${p}%</div>`;
    }

    el.innerHTML = `
      <div class="ach-info">
        <h4>${item.name}</h4>
        <p>${item.description}</p>
      </div>
      ${btnHtml}
    `;
    list.appendChild(el);
  });
}

window.claimAchievement = async (id) => {
  try{
    const res = await apiPost('/api/achievements/claim', {achievement_id: id});
    if(res.ok){
       setBalance(res.balance);
       // Refresh list to show claimed status
       loadAchievements();
       tg?.showPopup?.({message: `–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞! +${res.reward || ''}`});
    } else {
       tg?.showAlert?.(res.error || "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è");
    }
  }catch(e){
    tg?.showAlert?.("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
  }
};
</script>
</body>
</html>
