<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Чат — FirstClub</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/webapp_guard.js"></script>
  <style>
    :root{
      --bg:#0a0d12; --bg2:#0e1117; --panel:#0d1117;
      --card:#111722; --card2:#0f1520;
      --stroke:rgba(255,255,255,.06); --stroke2:rgba(100,160,255,.25);
      --blue:#3b82f6; --blue2:#1d4ed8;
      --text:#e6edf3; --muted:#98a2b3;
      --shadow:0 0 0 1px var(--stroke),0 8px 30px rgba(0,0,0,.6);
    }
    html,body{height:100%;overflow:hidden;overscroll-behavior:none;touch-action:manipulation;}
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,sans-serif;color:var(--text);
      background:linear-gradient(180deg,var(--bg2) 0%,var(--bg) 100%);
      display:flex;flex-direction:column;
    }
    header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--stroke);background:var(--panel);}
    .back{
      color:var(--text);text-decoration:none;font-weight:700;
      background:rgba(255,255,255,0.05);padding:8px 12px;border-radius:10px;
    }
    .chat-area{
      flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;
    }
    .msg{
      max-width:80%;padding:10px 14px;border-radius:14px;font-size:14px;line-height:1.4;word-wrap:break-word;
      animation:pop 0.2s ease-out; position:relative;
    }
    .msg.mine{
      align-self:flex-end;background:linear-gradient(135deg,var(--blue),var(--blue2));color:white;
      border-bottom-right-radius:2px;
    }
    .msg.other{
      align-self:flex-start;background:var(--card);border:1px solid var(--stroke);
      border-bottom-left-radius:2px;
    }
    .msg.grouped{
      margin-top:-4px; border-top-right-radius:14px; border-top-left-radius:14px;
    }
    .sender{font-size:11px;opacity:0.6;margin-bottom:2px;font-weight:700;}
    .time{font-size:10px; opacity:0.6; text-align:right; margin-top:4px;}
    .input-area{
      padding:12px;background:var(--panel);border-top:1px solid var(--stroke);display:flex;gap:10px;
    }
    input{
      flex:1;background:var(--bg);border:1px solid var(--stroke);color:var(--text);
      padding:10px 14px;border-radius:999px;font-size:15px;outline:none;
    }
    input:focus{border-color:var(--blue);}
    button{
      background:var(--blue);color:white;border:none;border-radius:999px;width:40px;height:40px;
      display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;
    }
    button:disabled{opacity:0.6;cursor:not-allowed;}
    @keyframes pop{from{transform:scale(0.9);opacity:0;}to{transform:scale(1);opacity:1;}}
  </style>
</head>
<body>
  <header>
    <a href="/community" class="back">← Назад</a>
    <div style="font-weight:800;">Общий чат</div>
    <div style="width:50px"></div>
  </header>

  <div class="chat-area" id="chat">
    <div style="text-align:center;color:var(--muted);font-size:12px;margin-top:20px;">
      Добро пожаловать в чат!<br>Запрещены оскорбления, нацизм, экстремизм.
    </div>
  </div>

  <div class="input-area">
    <input type="text" id="inp" placeholder="Сообщение (1 очко)..." maxlength="200">
    <button id="send">➤</button>
  </div>

  <script>
    const tgInstance = initTelegramGuard();
    const chat = document.getElementById('chat');
    const inp = document.getElementById('inp');
    const sendBtn = document.getElementById('send');
    let myName = "Player";
    let displayedMessages = new Set();
    let pollInterval = null;
    let lastMsg = null;

    async function init(){
      const prof = await fetchProfile();
      if(prof && prof.ok){
         myName = prof.username || prof.name || "Anon";
      }

      await loadHistory();
      pollInterval = setInterval(loadHistory, 2000);
    }

    async function loadHistory(){
        try {
            const res = await apiGet('/api/chat/history');
            if (res && res.ok && res.messages) {
                // Determine if we are at bottom to auto-scroll
                const isAtBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 50;

                res.messages.forEach(msg => {
                    const key = msg.id || JSON.stringify(msg);
                    if (!displayedMessages.has(key)) {
                        displayedMessages.add(key);
                        addMessage(msg);
                    }
                });

                if (isAtBottom) {
                    chat.scrollTop = chat.scrollHeight;
                }
            }
        } catch (e) {
            console.error('Chat poll error', e);
        }
    }

    function formatTime(ts){
      if(!ts) return "";
      const d = new Date(ts * 1000);
      return d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
    }

    function addMessage(msg){
      const {sender, text, timestamp} = msg;
      const isMe = sender === myName;

      // Grouping logic
      let shouldGroup = false;
      if (lastMsg && lastMsg.sender === sender) {
         const t1 = lastMsg.timestamp || 0;
         const t2 = timestamp || 0;
         // Group if within 60 seconds
         if (Math.abs(t2 - t1) < 60) {
             shouldGroup = true;
         }
      }

      const el = document.createElement('div');
      el.className = `msg ${isMe ? 'mine' : 'other'} ${shouldGroup ? 'grouped' : ''}`;

      if(!isMe && !shouldGroup){
        const s = document.createElement('div');
        s.className = 'sender';
        s.textContent = sender;
        el.appendChild(s);
      }

      const t = document.createElement('div');
      t.textContent = text;
      el.appendChild(t);

      const tm = document.createElement('div');
      tm.className = 'time';
      tm.textContent = formatTime(timestamp);
      el.appendChild(tm);

      chat.appendChild(el);
      lastMsg = msg;
    }

    async function send(){
      const txt = inp.value.trim();
      if(!txt) return;

      inp.disabled = true;
      sendBtn.disabled = true;

      try {
        const res = await apiPost('/api/chat/send', { text: txt });
        if(res && res.ok){
            inp.value = '';
            // Immediately fetch history to show own message faster?
            // Or just append locally if we trust backend?
            // Let's poll to be consistent.
            setTimeout(loadHistory, 100);
        } else {
            if(res.error === 'filtered') alert('Сообщение содержит запрещенные слова.');
            else if(res.error === 'not_enough_points') alert('Недостаточно очков для отправки (цена: 1 очко).');
            else alert('Ошибка отправки: ' + (res.error || 'Unknown'));
        }
      } catch (e) {
          alert('Ошибка соединения');
      } finally {
          inp.disabled = false;
          sendBtn.disabled = false;
          inp.focus();
      }
    }

    sendBtn.addEventListener('click', send);
    inp.addEventListener('keydown', (e)=>{if(e.key==='Enter') send();});

    init();
  </script>
</body>
</html>
