<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>–ö–æ—Å—Ç–∏ ‚Äî FirstGamble</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0a0d12; --bg2:#0e1117; --card:#111722;
      --text:#e6ebf4; --muted:#9aa4b2;
      --accent:#4da3ff; --accent2:#1f6feb;
      --win:#2ecc71; --lose:#ff6b6b; --draw:#f1c40f;
      --stroke: rgba(255,255,255,.06);
      --shadow: 0 0 0 1px var(--stroke), 0 10px 26px rgba(0,0,0,.45);
    }
    body.light{
      --bg:#f4f6fb; --bg2:#ffffff; --card:#ffffff;
      --text:#0e1520; --muted:#607086;
      --stroke: rgba(0,0,0,.08);
      --shadow: 0 0 0 1px var(--stroke), 0 8px 20px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(1200px 600px at 10% -10%, #13233a 0%, transparent 60%), var(--bg);
      color:var(--text);
      min-height:100vh;
      display:flex; justify-content:center; padding:16px;
    }
    .wrap{width:100%; max-width:720px}
    header{
      display:flex; align-items:center; gap:12px; margin-bottom:12px;
    }
    a.back{
      text-decoration:none; color:var(--text);
      background:var(--card); border-radius:12px; padding:8px 12px;
      box-shadow:var(--shadow); border:1px solid var(--stroke);
      font-weight:600;
    }
    .title h1{font-size:22px; margin:0}
    .title span{font-size:13px; color:var(--muted)}

    .panel{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:14px;
      box-shadow:var(--shadow);
      margin-bottom:12px;
    }
    .row{
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .badge{
      font-size:14px; color:var(--muted);
    }
    .balance{
      font-weight:800; font-size:18px;
      color:var(--accent);
    }
    .warn{
      font-size:13px; color:#ffb347; margin-top:6px; white-space:pre-line;
    }

    .dice-area{
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
      margin-top:8px;
    }
    .player{
      background:var(--bg2);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:12px;
      text-align:center;
    }
    .player h3{
      margin:0 0 8px 0; font-size:16px;
    }
    .dice-box{
      display:flex; justify-content:center; gap:10px; margin-bottom:8px;
    }
    .die{
      width:64px; height:64px; border-radius:12px;
      background:var(--card);
      display:grid; place-items:center;
      font-size:30px; font-weight:900;
      border:1px solid var(--stroke);
      box-shadow:var(--shadow);
      transition:transform .15s ease;
    }
    .rolling .die{ transform:rotate(8deg) scale(1.06); }

    .sum{
      font-size:15px; color:var(--muted);
    }

    button#rollBtn{
      width:100%; height:50px; border:none; border-radius:14px;
      background:linear-gradient(135deg,var(--accent2),var(--accent));
      color:white; font-size:16px; font-weight:800;
      cursor:pointer; box-shadow:0 10px 18px rgba(77,163,255,.25);
      margin-top:10px;
    }
    button#rollBtn:disabled{
      opacity:.6; cursor:not-allowed;
    }

    .result{
      font-size:18px; font-weight:900; text-align:center; margin-top:10px;
    }
    .result.win{ color:var(--win); }
    .result.lose{ color:var(--lose); }
    .result.draw{ color:var(--draw); }

    footer{
      text-align:center; font-size:12px; color:var(--muted); margin-top:8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a class="back" href="/ludka">‚Üê –ù–∞–∑–∞–¥</a>
      <div class="title">
        <h1>–ö–æ—Å—Ç–∏</h1>
        <span>–ë—Ä–æ—Å—å –∫–æ—Å—Ç–∏ –∏ –ø–æ–±–µ–¥–∏ –±–æ—Ç–∞</span>
      </div>
    </header>

    <div class="panel">
      <div class="row">
        <div class="badge">–í–∞—à–∏ –º–æ–Ω–µ—Ç—ã:</div>
        <div class="balance"><span id="balance">0</span>üí†</div>
      </div>
      <div id="tgWarn" class="warn"></div>
    </div>

    <div class="panel">
      <div class="dice-area" id="diceArea">
        <div class="player" id="youBlock">
          <h3>–¢—ã</h3>
          <div class="dice-box">
            <div class="die" id="youD1">?</div>
            <div class="die" id="youD2">?</div>
          </div>
          <div class="sum">–°—É–º–º–∞: <span id="youSum">0</span></div>
        </div>

        <div class="player" id="botBlock">
          <h3>–ë–æ—Ç</h3>
          <div class="dice-box">
            <div class="die" id="botD1">?</div>
            <div class="die" id="botD2">?</div>
          </div>
          <div class="sum">–°—É–º–º–∞: <span id="botSum">0</span></div>
        </div>
      </div>

      <button id="rollBtn">üé≤ –ë—Ä–æ—Å–∏—Ç—å –∫–æ—Å—Ç–∏</button>
      <div id="resultText" class="result"></div>
    </div>

    <footer>FirstGamble ‚Ä¢ Dice</footer>
  </div>

<script>
  const TG = window.Telegram?.WebApp;
  const API_BASE = "https://api.firstgamble.ru";

  // --- TG init + theme ---
  if (TG) {
    TG.ready();
    TG.expand();
    applyTheme(TG.colorScheme);
    TG.onEvent("themeChanged", () => applyTheme(TG.colorScheme));
  } else {
    applyTheme("dark");
  }

  function applyTheme(scheme){
    document.body.classList.toggle("light", scheme === "light");
  }

  function getTgUserId(){
    try {
      const uid = TG?.initDataUnsafe?.user?.id;
      if (uid) return String(uid);
    } catch(e){}
    const p = new URLSearchParams(location.search);
    return p.get("uid") || null;
  }

  // --- API ---
  async function loadBalance() {
    const uid = getTgUserId();
    const el = document.getElementById("balance");
    if (!uid) {
      el.textContent = "0";
      return;
    }
    try{
      const r = await fetch(`${API_BASE}/api/balance?user_id=${encodeURIComponent(uid)}`);
      const d = await r.json();
      el.textContent = (d.balance ?? 0);
      localStorage.setItem("balance", String(d.balance ?? 0));
    } catch(e){
      el.textContent = localStorage.getItem("balance") || "0";
    }
  }

  async function sendPoint(uid, delta=1){
    const r = await fetch(`${API_BASE}/api/add_point`,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ user_id: uid, delta })
    });
    const d = await r.json();
    if(!r.ok) throw new Error(d?.error || "add_point failed");
    document.getElementById("balance").textContent = d.balance;
    localStorage.setItem("balance", String(d.balance));
  }

  async function reportGame(uid, game, result){
    try{
      const r = await fetch(`${API_BASE}/api/report_game`,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ user_id: uid, game, result })
      });
      // –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ –ª–æ–≥, –∏–≥—Ä—É –Ω–µ –≤–∞–ª–∏–º
      if(!r.ok){
        const d = await r.json().catch(()=>({}));
        console.warn("report_game failed:", d);
      }
    }catch(e){
      console.warn("report_game error:", e);
    }
  }

  // --- Game ---
  const rollBtn = document.getElementById("rollBtn");
  const tgWarn = document.getElementById("tgWarn");
  const resultText = document.getElementById("resultText");

  const youD1 = document.getElementById("youD1");
  const youD2 = document.getElementById("youD2");
  const botD1 = document.getElementById("botD1");
  const botD2 = document.getElementById("botD2");
  const youSumEl = document.getElementById("youSum");
  const botSumEl = document.getElementById("botSum");
  const diceArea = document.getElementById("diceArea");

  const uid = getTgUserId();
  if(!uid){
    tgWarn.textContent =
      "‚ö†Ô∏è TG id –Ω–µ –ø—Ä–∏—à—ë–ª. –û—Ç–∫—Ä–æ–π –º–∏–Ω–∏–∞–ø–ø–∫—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –±–æ—Ç–∞.\n" +
      "–ï—Å–ª–∏ —Ç–µ—Å—Ç–∏—Ä—É–µ—à—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ ‚Äî –¥–æ–±–∞–≤—å ?uid=123 –≤ –∞–¥—Ä–µ—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É.";
    rollBtn.disabled = true;
  } else {
    tgWarn.textContent = "TG id: " + uid;
    rollBtn.disabled = false;
  }
  loadBalance();

  function randDie(){ return 1 + Math.floor(Math.random()*6); }

  let rollingTimer = null;

  function startRolling(){
    diceArea.classList.add("rolling");
    rollingTimer = setInterval(()=>{
      youD1.textContent = randDie();
      youD2.textContent = randDie();
      botD1.textContent = randDie();
      botD2.textContent = randDie();
    }, 90);
  }

  function stopRolling(final){
    clearInterval(rollingTimer);
    rollingTimer = null;
    diceArea.classList.remove("rolling");

    youD1.textContent = final.you1;
    youD2.textContent = final.you2;
    botD1.textContent = final.bot1;
    botD2.textContent = final.bot2;

    youSumEl.textContent = final.youSum;
    botSumEl.textContent = final.botSum;
  }

  rollBtn.addEventListener("click", async ()=>{
    if(rollingTimer) return;
    rollBtn.disabled = true;
    resultText.textContent = "";
    resultText.className = "result";

    startRolling();

    // –∏–º–∏—Ç–∞—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ 1.2 —Å–µ–∫
    setTimeout(async ()=>{
      const fin = {
        you1: randDie(),
        you2: randDie(),
        bot1: randDie(),
        bot2: randDie(),
      };
      fin.youSum = fin.you1 + fin.you2;
      fin.botSum = fin.bot1 + fin.bot2;

      stopRolling(fin);

      if(fin.youSum > fin.botSum){
        resultText.textContent = `–ü–æ–±–µ–¥–∞! ${fin.youSum} –ø—Ä–æ—Ç–∏–≤ ${fin.botSum}`;
        resultText.classList.add("win");
        try{
          await sendPoint(uid, 1);
        }catch(e){
          console.warn(e);
          TG?.showAlert?.("–°–µ—Ä–≤–µ—Ä –Ω–µ –ø—Ä–∏–Ω—è–ª –æ—á–∫–æ: " + e.message);
        }
        await reportGame(uid, "dice", "win");
      } else if (fin.youSum < fin.botSum){
        resultText.textContent = `–¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª. ${fin.youSum} –ø—Ä–æ—Ç–∏–≤ ${fin.botSum}`;
        resultText.classList.add("lose");
        await reportGame(uid, "dice", "lose");
      } else {
        resultText.textContent = `–ù–∏—á—å—è! ${fin.youSum} = ${fin.botSum}`;
        resultText.classList.add("draw");
        await reportGame(uid, "dice", "draw");
      }

      rollBtn.disabled = false;
    }, 1200);
  });
</script>
</body>
</html>
