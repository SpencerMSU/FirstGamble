<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Игра Дурак — FirstClub</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/webapp_guard.js"></script>
  <style>
    :root{
      --bg:#0a0d12; --bg2:#0e1117; --panel:#0d1117;
      --card-bg:white;
      --stroke:rgba(255,255,255,.06);
      --blue:#3b82f6; --green:#22c55e; --red:#ef4444;
      --text:#e6edf3;
    }
    html,body{height:100%;overflow:hidden;overscroll-behavior:none;touch-action:none;}
    body{
      margin:0;font-family:system-ui,sans-serif;color:var(--text);
      background:radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
      display:flex;flex-direction:column;
    }
    /* 3D Scene */
    .scene{
      flex:1; perspective:1000px; position:relative; overflow:hidden;
    }

    /* Card Styles */
    .card{
      width:70px; height:100px; background:var(--card-bg); border-radius:6px;
      position:absolute; box-shadow:0 2px 10px rgba(0,0,0,0.5);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; font-size:24px; user-select:none;
      transform-style:preserve-3d; transition:transform 0.3s ease, left 0.3s ease, top 0.3s ease;
      cursor:pointer; border:1px solid #ccc;
    }
    .card.red{color:#e11d48;} .card.black{color:#1e293b;}
    .card .suit{font-size:32px;}
    .card .rank{position:absolute;top:4px;left:4px;font-size:14px;}
    .card.selected{transform:translateY(-20px) scale(1.05); box-shadow:0 0 15px var(--blue);}

    /* Slots */
    .table-area{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotateX(20deg);
      width:300px;height:200px;
      display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-content:center;
    }
    .card-slot{
      width:70px;height:100px;border:2px dashed rgba(255,255,255,0.1);border-radius:6px;
      position:relative;
    }

    /* Hand */
    .my-hand{
      position:absolute;bottom:-40px;left:0;width:100%;height:140px;
      display:flex;justify-content:center;align-items:flex-end;gap:-20px;
      perspective:600px;
    }
    .my-card-wrap{
      width:70px;height:100px;transition:0.2s;margin-left:-25px;
    }
    .my-card-wrap:first-child{margin-left:0;}
    .my-card-wrap:hover{transform:translateY(-30px);z-index:10;}

    /* Opponents (Simplified: Top) */
    .opp-top{position:absolute;top:10px;width:100%;display:flex;justify-content:center;gap:4px;}
    .opp-card-back{width:40px;height:56px;background:#334155;border-radius:4px;border:1px solid rgba(255,255,255,0.1);}

    /* UI Overlay */
    .ui{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
    .controls{
      position:absolute;bottom:120px;right:20px;display:flex;flex-direction:column;gap:10px;pointer-events:auto;
    }
    .btn{
      padding:12px 20px;border-radius:12px;border:none;font-weight:700;box-shadow:0 4px 12px rgba(0,0,0,0.5);
      cursor:pointer;font-size:14px;
    }
    .btn-action{background:var(--blue);color:white;}
    .btn-pass{background:#64748b;color:white;}
    .status-bar{
      position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.5);
      padding:6px 12px;border-radius:8px;font-size:12px;color:var(--text);pointer-events:auto;
    }

    .modal{
      position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:99;
      pointer-events:auto;
    }
    .modal.hidden{display:none;}
    .modal-content{background:var(--panel);padding:24px;border-radius:16px;text-align:center;}
  </style>
</head>
<body>

  <div class="scene">
    <div class="opp-top" id="oppHand"></div>

    <div class="table-area" id="table">
      <!-- Slots for pairs -->
    </div>

    <div class="my-hand" id="myHand">
      <!-- My Cards -->
    </div>
  </div>

  <div class="ui">
    <div class="status-bar">
      Room: <span id="roomId">...</span><br>
      Status: <span id="status">Waiting...</span>
    </div>

    <div class="controls hidden" id="controls">
      <button class="btn btn-action" id="actionBtn">Бито / Беру</button>
    </div>
  </div>

  <div class="modal" id="startModal">
    <div class="modal-content">
      <h2 id="modalTitle">Ожидание игроков...</h2>
      <p id="modalDesc">Нужно минимум 2 игрока</p>
      <button class="btn btn-action hidden" id="readyBtn">ГОТОВ</button>
    </div>
  </div>

<script>
  const tgInstance = initTelegramGuard();
  const roomId = new URLSearchParams(window.location.search).get('room');
  const userId = getTgUserId() || new URLSearchParams(window.location.search).get('uid');

  if(!roomId){ alert("No room"); window.location.href='/ludka/durak.html'; }
  document.getElementById('roomId').textContent = roomId;

  let ws;
  let gameState = null;
  let selectedHandIdx = null;

  function getTgUserId(){ try{return tg?.initDataUnsafe?.user?.id;}catch(e){return null;} }

  function init(){
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const url = `${protocol}//${window.location.host}/ws/durak/${roomId}?uid=${userId}`;
    ws = new WebSocket(url);
    ws.onmessage = onMsg;
    ws.onclose = () => { alert("Связь потеряна"); window.location.href='/ludka/durak.html'; };
  }

  function onMsg(e){
    const msg = JSON.parse(e.data);
    if(msg.type === 'state'){
      gameState = msg.payload;
      render();
    }
  }

  function render(){
    const s = gameState;
    const statusEl = document.getElementById('status');
    const startModal = document.getElementById('startModal');
    const readyBtn = document.getElementById('readyBtn');
    const controls = document.getElementById('controls');
    const actionBtn = document.getElementById('actionBtn');

    // Status
    statusEl.textContent = `${s.state} | Trump: ${s.trump_suit} | Deck: ${s.deck_count}`;

    // Waiting Screen
    if(s.state === 'waiting'){
      startModal.classList.remove('hidden');
      const me = s.players.find(p => p.uid == userId);
      if(me){
        if(me.ready){
          document.getElementById('modalTitle').textContent = "Вы готовы";
          readyBtn.classList.add('hidden');
        } else {
          document.getElementById('modalTitle').textContent = "Нажмите Готов";
          readyBtn.classList.remove('hidden');
        }
      }
      document.getElementById('modalDesc').textContent = `Игроков: ${s.players.length}/4. Ожидание готовности.`;
    } else {
      startModal.classList.add('hidden');
    }

    // My Hand
    const myHandEl = document.getElementById('myHand');
    const me = s.players.find(p => p.uid == userId);
    myHandEl.innerHTML = '';
    if(me && me.hand){
      me.hand.forEach((c, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'my-card-wrap';
        const el = createCardEl(c);
        el.onclick = () => onCardClick(idx);
        if(selectedHandIdx === idx) el.classList.add('selected');
        wrap.appendChild(el);
        myHandEl.appendChild(wrap);
      });
    }

    // Table
    const tableEl = document.getElementById('table');
    tableEl.innerHTML = '';
    s.table.forEach((pair, idx) => {
      const slot = document.createElement('div');
      slot.className = 'card-slot';

      const atk = createCardEl(pair.attack);
      atk.style.position = 'absolute';
      atk.style.left = '0'; atk.style.top = '0';
      slot.appendChild(atk);

      if(pair.defend){
        const def = createCardEl(pair.defend);
        def.style.position = 'absolute';
        def.style.left = '10px'; def.style.top = '10px';
        def.style.transform = 'rotate(5deg)';
        slot.appendChild(def);
      } else {
        // Allow click slot to defend if defender
        if(me && me.is_defender && selectedHandIdx !== null){
          slot.onclick = () => sendAction('defend', {target_idx: idx, card: me.hand[selectedHandIdx]});
        }
      }
      tableEl.appendChild(slot);
    });

    // Controls
    if(s.state === 'playing' && me){
      controls.classList.remove('hidden');
      if(me.is_attacker){
         actionBtn.textContent = "Бито / Пас";
         actionBtn.onclick = () => sendAction('pass', {});
         // If selected card, click anywhere on table? No, create new slot logic?
         // Simplification: Attacker clicks 'Pass' to end adding.
         // Attacking happens by clicking card when not targeting slot?
         // Logic: if selected card and clicked "Empty Space" -> attack.
         // But "Empty Space" is scene background.
         // Let's create a dedicated "Attack Zone" or just button "Throw Selected"?
         // Better: Double click card to throw? Or Tap card to select, Tap Table Area to throw.
      } else if(me.is_defender){
         actionBtn.textContent = "Взять";
         actionBtn.onclick = () => sendAction('take', {});
      } else {
         // Other player
         actionBtn.textContent = "Пас";
         actionBtn.onclick = () => sendAction('pass', {});
      }
    } else {
      controls.classList.add('hidden');
    }
  }

  function createCardEl(c){
    const el = document.createElement('div');
    const isRed = ['H','D'].includes(c.suit);
    el.className = `card ${isRed?'red':'black'}`;

    let suitIcon = '';
    if(c.suit==='H') suitIcon='♥';
    if(c.suit==='D') suitIcon='♦';
    if(c.suit==='C') suitIcon='♣';
    if(c.suit==='S') suitIcon='♠';

    el.innerHTML = `<span class="rank">${c.rank}</span><span class="suit">${suitIcon}</span>`;
    return el;
  }

  function onCardClick(idx){
    if(selectedHandIdx === idx){
      // Deselect
      selectedHandIdx = null;
    } else {
      selectedHandIdx = idx;
    }
    render();

    // Try auto-action if attacker
    const me = gameState.players.find(p => p.uid == userId);
    if(me && me.is_attacker && selectedHandIdx !== null){
       // If no cards on table, or if adding...
       // Confirmation via "Throw" button?
       // Let's add a dynamic button for "Throw Selected"
       // Or handle table click.
    }
  }

  // Interaction for attacking:
  // If attacker, tap card (select), then tap "Table Area" to throw.
  document.getElementById('table').addEventListener('click', (e)=>{
    if(e.target === document.getElementById('table')){ // Clicked void area
       const me = gameState.players.find(p => p.uid == userId);
       if(me && (me.is_attacker || !me.is_defender) && selectedHandIdx !== null){
          sendAction('attack', {card: me.hand[selectedHandIdx]});
          selectedHandIdx = null;
       }
    }
  });

  function sendAction(act, data){
    ws.send(JSON.stringify({action: act, ...data}));
  }

  document.getElementById('readyBtn').onclick = () => sendAction('ready', {});

  init();

</script>
</body>
</html>
