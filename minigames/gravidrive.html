<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ì—Ä–∞–≤–∏-–¥—Ä–∞–π–≤ ‚Äî FirstClub</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/webapp_guard.js"></script>
  <script src="/ludka/gravirun_logic_adapter.js"></script>
  <style>
    :root{
      --bg:#05070c; --bg2:#0a0f1d; --panel:#0d1117;
      --card:#0f1624; --card2:#0f172a;
      --stroke:rgba(255,255,255,.08); --stroke2:rgba(99,143,255,.35);
      --blue:#60a5fa; --violet:#8b5cf6; --green:#22c55e; --amber:#f59e0b; --red:#ef4444;
      --text:#e6edf3; --muted:#9ca3af; --shadow:0 0 0 1px var(--stroke),0 8px 32px rgba(0,0,0,.7);
    }
    html[data-theme="light"]{
      --bg:#f4f7fb; --bg2:#eef2f7; --panel:#ffffff;
      --card:#ffffff; --card2:#f6f8fb;
      --stroke:rgba(10,20,40,.08); --stroke2:rgba(59,130,246,.35);
      --text:#0b1220; --muted:#52607a; --shadow:0 0 0 1px var(--stroke),0 10px 24px rgba(10,20,40,.08);
    }
    html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-overflow-scrolling:auto;touch-action:manipulation;}
    *{box-sizing:border-box;}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--text);
      background:
        radial-gradient(900px 540px at 15% -20%, rgba(96,165,250,.28), transparent 60%),
        radial-gradient(900px 520px at 120% 0%, rgba(139,92,246,.24), transparent 55%),
        linear-gradient(180deg, var(--bg2) 0%, var(--bg) 100%);
      min-height:100vh; display:flex; justify-content:center; padding:16px;
    }
    .app{width:min(1000px,100%);border:1px solid var(--stroke);border-radius:20px;box-shadow:var(--shadow);padding:14px;
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));height:100%;overflow-y:auto;overscroll-behavior:none;}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px 14px;gap:10px;}
    .title{display:flex;flex-direction:column;gap:2px;align-items:flex-start;}
    .title h1{margin:0;font-size:20px;font-weight:800;}
    .title span{font-size:12px;color:var(--muted);}
    .back{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;
      background:linear-gradient(180deg,var(--card) 0%, var(--card2) 100%);
      border:1px solid var(--stroke);color:var(--text);text-decoration:none;font-weight:700;font-size:14px;
      cursor:pointer;transition:.15s ease;}
    .back:hover{border-color:var(--stroke2);transform:translateY(-1px);}
    .layout{display:grid;grid-template-columns:1fr 320px;gap:12px;align-items:start;}
    @media(max-width:900px){.layout{grid-template-columns:1fr;}}
    .section{background:linear-gradient(180deg,var(--panel) 0%,color-mix(in oklab,var(--panel) 90%,transparent) 100%);
      border:1px solid var(--stroke);border-radius:16px;padding:14px;box-shadow:var(--shadow);}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-weight:800;font-size:13px;
      border:1px solid var(--stroke);background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);}
    .grid{display:flex;flex-wrap:wrap;gap:8px;}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--stroke2);
      background:linear-gradient(180deg,var(--violet) 0%,var(--blue) 100%);
      color:white;font-weight:900;cursor:pointer;transition:.15s ease;box-shadow:0 6px 18px rgba(99,102,241,.35);}
    .btn.secondary{background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);color:var(--text);border-color:var(--stroke);box-shadow:none;}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    canvas{width:100%;border-radius:16px;border:1px solid var(--stroke);background:linear-gradient(180deg,#0a0f1d,#0b1220);
      box-shadow:inset 0 0 24px rgba(0,0,0,.4);}
    .stats{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;}
    .note{font-size:12px;color:var(--muted);margin:6px 0 0;line-height:1.6;}
    .status{font-size:16px;font-weight:900;margin:8px 0 0;}
    .status.win{color:var(--green);} .status.lose{color:var(--red);} .status.idle{color:var(--muted);}
    .badge{display:inline-flex;align-items:center;gap:6px;font-weight:800;font-size:13px;}
    .legend{display:flex;flex-direction:column;gap:10px;}
    .legend-row{display:flex;align-items:center;gap:8px;}
    .legend-swatch{width:16px;height:16px;border-radius:6px;}
    .gallery{display:flex;gap:8px;flex-wrap:wrap;}
    .gallery img{width:36px;height:36px;border-radius:10px;border:1px solid var(--stroke);background:var(--card);}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%) translateY(20px);
      background:rgba(11,16,24,.94);border:1px solid var(--stroke2);color:var(--text);padding:10px 14px;border-radius:12px;
      font-size:13px;opacity:0;transition:.2s ease;box-shadow:var(--shadow);z-index:9999;pointer-events:none;white-space:nowrap;}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
    .mobile-controls{display:none;gap:10px;width:100%;justify-content:center;flex-wrap:wrap;}
    .mobile-controls .tap{flex:1;min-width:96px;max-width:160px;padding:12px;border-radius:14px;border:1px solid var(--stroke2);
      background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);color:var(--text);font-weight:800;font-size:14px;
      box-shadow:0 10px 26px rgba(0,0,0,.35);}
    @media(max-width:900px){
      .mobile-controls{display:flex;}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <a class="back" href="/minigames">‚Üê –ú–∏–Ω–∏–∏–≥—Ä—ã</a>
      <div class="title">
        <h1>–ì—Ä–∞–≤–∏-–¥—Ä–∞–π–≤</h1>
        <span>–ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è –º–µ–∂–¥—É –ª—É—á–∞–º–∏, —Å–æ–±–∏—Ä–∞–π –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –∏ –Ω–µ –∑–∞–¥–µ–≤–∞–π —à–∏–ø—ã</span>
      </div>
      <div class="gallery" aria-label="–ò–∫–æ–Ω–∫–∏ –≥—Ä–∞–≤–∏-–¥—Ä–∞–π–≤–∞">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g1' x1='8' x2='56' y1='40' y2='8' gradientUnits='userSpaceOnUse'%3E%3Cstop stop-color='%2360a5fa'/%3E%3Cstop offset='1' stop-color='%2322d3ee'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath fill='url(%23g1)' d='M10 46c5-10 18-22 40-36l-8 18c8 2 12 9 10 16-2 8-12 12-22 9-9-3-14-10-12-17z'/%3E%3Ccircle cx='38' cy='34' r='5' fill='%23fff' fill-opacity='.8'/%3E%3C/svg%3E" alt="–ö–æ–º–µ—Ç–∞">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3CradialGradient id='g2' cx='24' cy='24' r='28' gradientUnits='userSpaceOnUse'%3E%3Cstop stop-color='%23fbbf24'/%3E%3Cstop offset='.55' stop-color='%23f59e0b'/%3E%3Cstop offset='1' stop-color='%23b45309'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='22' fill='url(%23g2)'/%3E%3Ccircle cx='22' cy='26' r='4' fill='%23fff' fill-opacity='.9'/%3E%3Ccircle cx='40' cy='40' r='6' fill='%231f2937' fill-opacity='.28'/%3E%3Cpath fill='%23fef3c7' d='M46 18c1 3-1 7-4 8 2-3 1-6-1-8 2-1 4-1 5 0z'/%3E%3C/svg%3E" alt="–ê—Å—Ç–µ—Ä–æ–∏–¥">
        <img src="https://img.icons8.com/fluency/48/flash-on.png" alt="–ë—É—Å—Ç">
      </div>
    </header>

    <div class="layout">
      <section class="section" style="display:flex;flex-direction:column;gap:12px;align-items:center;">
        <canvas id="board" width="720" height="420"></canvas>
        <div class="stats">
          <span class="pill">üéØ –¶–µ–ª—å: 25 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤</span>
          <span class="pill">üî• –°–µ—Ä–∏—è: <span id="streak">0</span></span>
          <span class="pill">‚≠ê –û—á–∫–∏: <span id="score">0</span></span>
          <span class="pill">‚ù§Ô∏è –ñ–∏–∑–Ω–∏: <span id="lives">3</span></span>
          <span class="pill">‚ö° –ë—É—Å—Ç: <span id="boost">–≥–æ—Ç–æ–≤</span></span>
        </div>
        <div class="controls">
          <button id="startBtn" class="btn">–ò–≥—Ä–∞—Ç—å</button>
          <button id="restartBtn" class="btn secondary">–°–±—Ä–æ—Å–∏—Ç—å</button>
          <div class="badge">‚Üê / ‚Üí / SPACE –∏–ª–∏ —Ç–∞–ø –ø–æ –∫–Ω–æ–ø–∫–∞–º</div>
        </div>
        <div class="mobile-controls" aria-label="–ö–Ω–æ–ø–∫–∏ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
          <button class="tap" data-action="left">üëà –í–ª–µ–≤–æ</button>
          <button class="tap" data-action="dash">‚ö° –ë—É—Å—Ç</button>
          <button class="tap" data-action="right">üëâ –í–ø—Ä–∞–≤–æ</button>
        </div>
        <div style="width:100%;max-width:840px;">
          <div id="status" class="status idle">–£–≤–æ—Ä–∞—á–∏–≤–∞–π—Å—è –æ—Ç —à–∏–ø–æ–≤, —Å–æ–±–∏—Ä–∞–π –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –∏ –∫–æ–ø–∏ –±—É—Å—Ç.</div>
        </div>
      </section>

      <section class="section" style="display:flex;flex-direction:column;gap:12px;">
        <div class="legend">
          <div class="legend-row"><span class="legend-swatch" style="background:#60a5fa;"></span><strong>–ö—Ä–∏—Å—Ç–∞–ª–ª—ã</strong> ‚Äî
            +1 –æ—á–∫–æ, +1 –∫ —Å–µ—Ä–∏–∏</div>
          <div class="legend-row"><span class="legend-swatch" style="background:#ef4444;"></span><strong>–®–∏–ø—ã</strong> ‚Äî
            ‚àí1 –∂–∏–∑–Ω—å, —Å–µ—Ä–∏—è —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è</div>
          <div class="legend-row"><span class="legend-swatch" style="background:#f59e0b;"></span><strong>–ë—É—Å—Ç</strong> ‚Äî
            —â–∏—Ç –Ω–∞ 1.5 —Å–µ–∫ –∏ –¥–≤–æ–π–Ω—ã–µ –æ—á–∫–∏</div>
        </div>
      </section>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none;"></div>

<script>
  const tgInstance = initTelegramGuard();
  const searchUid = new URLSearchParams(window.location.search).get("uid");

  const board = document.getElementById('board');
  const ctx = board.getContext('2d');
  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');
  const statusEl = document.getElementById('status');
  const scoreEl = document.getElementById('score');
  const livesEl = document.getElementById('lives');
  const streakEl = document.getElementById('streak');
  const boostEl = document.getElementById('boost');
  const toast = document.getElementById('toast');
  const mobileControls = document.querySelector('.mobile-controls');
  const tapButtons = document.querySelectorAll('.mobile-controls .tap');

  const lanes = [board.width * 0.15, board.width * 0.35, board.width * 0.55, board.width * 0.78];
  const laneColors = ['#60a5fa', '#8b5cf6', '#22c55e', '#f59e0b'];
  const playerY = board.height * 0.8;
  const goal = 25;

  let cppState = GravirunCpp.makeState();
  let streak = 0;
  let running = false;
  let lastTime = 0;
  let rafId = null;
  let resultSent = false;

  function setStatus(text, cls='idle'){
    statusEl.className = 'status '+cls;
    statusEl.textContent = text;
  }

  const isDesktopTelegram = tgInstance && ['tdesktop','desktop','web'].includes(tgInstance.platform);
  if(isDesktopTelegram && mobileControls){
    mobileControls.style.display = 'none';
    mobileControls.setAttribute('aria-hidden','true');
  }

  function showToast(text){
    toast.textContent = text;
    toast.style.display = 'block';
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1400);
  }

  function resetGame(autoStart=false){
    cppState = GravirunCpp.makeState();
    streak = 0;
    running = false;
    resultSent = false;
    updateUi();
    setStatus('–ù–∞–∂–º–∏ ¬´–ò–≥—Ä–∞—Ç—å¬ª –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫–∏, —á—Ç–æ–±—ã —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å.', 'idle');
    draw(0);
    if(autoStart){
      startGame();
    }
  }

  function updateUi(){
    scoreEl.textContent = cppState.score;
    livesEl.textContent = cppState.lives;
    streakEl.textContent = streak;
    boostEl.textContent = cppState.boostTimer > 0 ? '–∞–∫—Ç–∏–≤–µ–Ω' : '–Ω–µ—Ç';
  }

  function draw(progress){
    ctx.clearRect(0,0,board.width,board.height);
    const grad = ctx.createLinearGradient(0,0,0,board.height);
    grad.addColorStop(0,'#0b1220'); grad.addColorStop(1,'#060910');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,board.width,board.height);

    ctx.setLineDash([6,10]);
    ctx.lineWidth = 3;
    lanes.forEach((x)=>{
      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.beginPath();
      ctx.moveTo(x, 24);
      ctx.lineTo(x, board.height-24);
      ctx.stroke();
    });
    ctx.setLineDash([]);

    ctx.fillStyle = 'rgba(255,255,255,0.05)';
    ctx.fillRect(16, playerY-36, board.width-32, 70);

    cppState.objects.forEach(obj=>{
      const laneX = lanes[obj.lane];
      const size = 30;
      const objY = obj.y * board.height;
      if(obj.type === 'c'){
        const g = ctx.createLinearGradient(laneX-size/2, objY-size/2, laneX+size/2, objY+size/2);
        g.addColorStop(0,'#60a5fa'); g.addColorStop(1,'#22d3ee');
        ctx.fillStyle = g;
        ctx.shadowColor = '#60a5fa';
        ctx.shadowBlur = 10;
        ctx.beginPath();
        ctx.moveTo(laneX, objY-size/1.2);
        ctx.lineTo(laneX+size/1.8, objY);
        ctx.lineTo(laneX, objY+size/1.2);
        ctx.lineTo(laneX-size/1.8, objY);
        ctx.closePath();
        ctx.fill();
        ctx.shadowBlur = 0;
      }else if(obj.type === 's'){
        ctx.fillStyle = '#ef4444';
        ctx.beginPath();
        ctx.moveTo(laneX, objY-size/1.4);
        ctx.lineTo(laneX+size/2.4, objY+size/1.4);
        ctx.lineTo(laneX-size/2.4, objY+size/1.4);
        ctx.closePath();
        ctx.fill();
      }else{
        ctx.fillStyle = '#f59e0b';
        ctx.beginPath();
        ctx.arc(laneX, objY, size/2.6, 0, Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.25)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(laneX, objY, size/2.6+4, 0, Math.PI*2);
        ctx.stroke();
      }
    });

    const px = lanes[cppState.playerLane];
    const bodyGrad = ctx.createLinearGradient(px-30, playerY-10, px+30, playerY+10);
    bodyGrad.addColorStop(0,'#8b5cf6'); bodyGrad.addColorStop(1,'#22d3ee');
    ctx.fillStyle = bodyGrad;
    ctx.shadowColor = cppState.boostTimer>0 ? '#f59e0b' : '#8b5cf6';
    ctx.shadowBlur = cppState.boostTimer>0 ? 18 : 8;
    ctx.beginPath();
    ctx.roundRect(px-26, playerY-20, 52, 40, 12);
    ctx.fill();
    ctx.shadowBlur = 0;

    ctx.fillStyle = '#0b0f14';
    ctx.beginPath();
    ctx.arc(px-10, playerY-4, 4, 0, Math.PI*2);
    ctx.arc(px-10, playerY+4, 4, 0, Math.PI*2);
    ctx.fill();
  }

  function moveLane(delta){
    cppState.playerLane = Math.min(lanes.length-1, Math.max(0, cppState.playerLane + delta));
    setStatus('–õ–∏–Ω–∏—è: '+(cppState.playerLane+1), '');
  }

  function activateBoost(){
    showToast('–ë—É—Å—Ç –≤–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–±–æ—Ä–µ');
    setStatus('–õ–æ–≤–∏ –±—É—Å—Ç ‚Äî –æ–Ω –≤–∫–ª—é—á–∏—Ç —â–∏—Ç —Å–∞–º', 'idle');
  }

  function applyCppEvents(events){
    events.forEach(ev=>{
      if(ev.type === 'crystal'){
        streak += 1;
        showToast(`+${ev.points} –æ—á–∫–æ`);
        if(cppState.score >= goal){
          finish('win','–ê—Ç—Ç—Ä–∞–∫—Ç–æ—Ä –∑–∞—Ä—è–∂–µ–Ω! +1 –æ—á–∫–æ —Ä–µ–π—Ç–∏–Ω–≥–∞.');
        }
      }else if(ev.type === 'spike'){
        if(ev.lifeLost){
          streak = 0;
          setStatus('–ë–æ–ª—å–Ω–æ–π –∫–æ–Ω—Ç–∞–∫—Ç! –û—Å—Ç–∞–ª–æ—Å—å –∂–∏–∑–Ω–µ–π: '+cppState.lives, 'lose');
          showToast('‚àí1 –∂–∏–∑–Ω—å');
          if(cppState.lives <= 0){
            finish('loss','–ö–æ—Ä–∞–±–ª—å —Ä–∞–∑–±–∏—Ç. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë.');
          }
        }else{
          showToast('–©–∏—Ç —Å–ø–∞—Å–∞–µ—Ç');
        }
      }else if(ev.type === 'boost'){
        showToast('–ë—É—Å—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω');
        setStatus('–©–∏—Ç –Ω–∞ 1.5 —Å–µ–∫ ‚Äî –æ—á–∫–∏ —É–¥–≤–∞–∏–≤–∞—é—Ç—Å—è', 'win');
      }
    });
    if(!events.length && cppState.boostTimer <= 0 && running){
      setStatus('–î–µ—Ä–∂–∏ –∫—É—Ä—Å –∏ —Å–æ–±–∏—Ä–∞–π –∫—Ä–∏—Å—Ç–∞–ª–ª—ã.', '');
    }
  }

  function gameLoop(ts){
    if(!lastTime) lastTime = ts;
    const dt = Math.min(0.033, (ts-lastTime)/1000);
    lastTime = ts;
    if(running){
      const result = GravirunCpp.gravirunStepCpp(cppState, dt, {boardHeight: board.height});
      cppState = result.state;
      applyCppEvents(result.events);
      updateUi();
      draw(dt);
      rafId = requestAnimationFrame(gameLoop);
    }
  }

  function startGame(){
    if(running) return;
    running = true;
    lastTime = 0;
    setStatus('–î–µ—Ä–∂–∏ –∫—É—Ä—Å –∏ —Å–æ–±–∏—Ä–∞–π –∫—Ä–∏—Å—Ç–∞–ª–ª—ã.', '');
    if(rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(gameLoop);
  }

  function finish(result, message){
    running = false;
    if(rafId) cancelAnimationFrame(rafId);
    setStatus(message, result==='win'?'win':'lose');
    reportResult(result);
  }

  async function apiPost(url, data){
    try{
      const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
      return await res.json();
    }catch(e){return {ok:false,error:String(e)}}
  }

  async function reportResult(result){
    if(resultSent) return;
    resultSent = true;
    const uid = tg?.initDataUnsafe?.user?.id || searchUid;
    if(!uid) return;
    await apiPost('/api/report_game', {user_id:String(uid), game:'gravirun', result});
    if(result === 'win'){
      await apiPost('/api/add_point', {user_id:String(uid), game:'gravirun', delta:1});
    }
  }

  startBtn.addEventListener('click', ()=>{ startGame(); });
  restartBtn.addEventListener('click', ()=>{ resetGame(true); });

  document.addEventListener('keydown', (e)=>{
    if(e.code === 'ArrowLeft' || e.code === 'KeyA'){ moveLane(-1); if(!running) startGame(); }
    if(e.code === 'ArrowRight' || e.code === 'KeyD'){ moveLane(1); if(!running) startGame(); }
    if(e.code === 'Space'){ if(!running) startGame(); activateBoost(); }
  });

  tapButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const action = btn.dataset.action;
      btn.animate({transform:['translateY(0)','translateY(2px)'], opacity:[1,0.9]}, {duration:140});
      if(action === 'left'){ moveLane(-1); if(!running) startGame(); }
      if(action === 'right'){ moveLane(1); if(!running) startGame(); }
      if(action === 'dash'){ if(!running) startGame(); activateBoost(); }
    });
  });

  resetGame(true);

  (async()=>{
    if(!tgInstance) return;
    const uid = tg?.initDataUnsafe?.user?.id || searchUid;
    await ensureNicknameOrRedirect(uid);
  })();
</script>
</body>
</html>
