<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RPG ‚Äî FirstClub</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/webapp_guard.js"></script>
  <style>
    :root{
      --bg:#0a0d12;--bg2:#0e1117;--panel:#0d1117;--card:#111722;--card2:#0f1520;
      --stroke:rgba(255,255,255,.06);--stroke2:rgba(100,160,255,.25);
      --blue:#3b82f6;--blue2:#1d4ed8;--text:#e6edf3;--muted:#98a2b3;
      --green:#22c55e;--amber:#f59e0b;--purple:#a855f7;--teal:#14b8a6;
      --shadow:0 0 0 1px var(--stroke),0 8px 30px rgba(0,0,0,.6);
    }
    html[data-theme="light"]{
      --bg:#f4f7fb;--bg2:#eef2f7;--panel:#ffffff;--card:#ffffff;--card2:#f6f8fb;
      --stroke:rgba(10,20,40,.08);--stroke2:rgba(59,130,246,.35);
      --blue:#2563eb;--blue2:#1d4ed8;--text:#0b1220;--muted:#52607a;
      --green:#16a34a;--amber:#d97706;--purple:#9333ea;--teal:#0d9488;
      --shadow:0 0 0 1px var(--stroke),0 10px 26px rgba(10,20,40,.08);
    }
    html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-overflow-scrolling:auto;touch-action:manipulation;}
    *{box-sizing:border-box;}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background:radial-gradient(1000px 600px at 10% -10%,rgba(59,130,246,.28),transparent 60%),
      radial-gradient(800px 500px at 110% 0%,rgba(29,78,216,.22),transparent 55%),
      linear-gradient(180deg,var(--bg2) 0%,var(--bg) 100%);
      min-height:100vh;display:flex;justify-content:center;padding:16px;
    }
    .app{position:relative;width:min(900px,100%);border:1px solid var(--stroke);border-radius:20px;box-shadow:var(--shadow);padding:14px;
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));height:100%;overflow-y:auto;overscroll-behavior:none;}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px 14px;gap:10px;}
    .title{display:flex;flex-direction:column;gap:2px;align-items:flex-start;}
    .title h1{margin:0;font-size:20px;font-weight:800;}
    .title span{font-size:12px;color:var(--muted);}
    .back{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
      border:1px solid var(--stroke);color:var(--text);text-decoration:none;font-weight:700;font-size:14px;cursor:pointer;transition:.15s ease;}
    .back:hover{border-color:var(--stroke2);transform:translateY(-1px);}
    .section{background:linear-gradient(180deg,var(--panel) 0%,color-mix(in oklab,var(--panel) 92%,transparent) 100%);border:1px solid var(--stroke);
      border-radius:16px;padding:16px;box-shadow:var(--shadow);}
    .tabs{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-bottom:12px;}
    .tab{padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
      font-weight:800;font-size:13px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:.15s ease;justify-content:center;color:var(--text);}
    .tab a{color:inherit;text-decoration:none;}
    .tab.active{border-color:var(--stroke2);box-shadow:0 6px 20px rgba(59,130,246,.22);color:var(--blue);background:linear-gradient(180deg,color-mix(in oklab,var(--card) 90%,var(--stroke2)) 0%,var(--card2) 100%);}
    .tab:disabled{color:var(--text);opacity:.7;cursor:not-allowed;}
    .tab:hover{border-color:var(--stroke2);}
    .muted{color:var(--muted);font-size:13px;margin:0;line-height:1.45;}
    .title-row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--stroke2);
      color:var(--text);background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);font-weight:800;width:max-content;}
    .primary-btn{padding:12px 16px;border-radius:12px;border:1px solid var(--stroke2);background:linear-gradient(180deg,var(--blue) 0%,var(--blue2) 100%);
      color:white;font-weight:900;cursor:pointer;transition:.15s ease;box-shadow:0 8px 22px rgba(37,99,235,.35);}
    .primary-btn:disabled{opacity:.7;cursor:not-allowed;box-shadow:none;}
    .resource-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;}
    @media(max-width:720px){.resource-grid{grid-template-columns:1fr;}}
    .resource-card{border:1px solid var(--stroke);border-radius:14px;padding:12px;background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
      display:flex;flex-direction:column;gap:10px;box-shadow:var(--shadow);}
    .resource-head{display:flex;align-items:center;gap:10px;justify-content:space-between;}
    .resource-name{margin:0;font-weight:900;font-size:15px;display:flex;align-items:center;gap:6px;}
    .progress{width:100%;height:10px;border-radius:999px;background:rgba(255,255,255,.06);position:relative;overflow:hidden;border:1px solid var(--stroke);}
    .progress-fill{position:absolute;left:0;top:0;bottom:0;border-radius:999px;}
    .resource-row{display:flex;align-items:center;justify-content:space-between;font-weight:800;font-size:13px;color:var(--muted);}
    .note{font-size:12px;color:var(--muted);margin:6px 0 0;line-height:1.5;}
    .list{display:flex;flex-direction:column;gap:10px;margin-top:10px;}
    .list-item{border:1px dashed var(--stroke);border-radius:12px;padding:10px 12px;background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);display:flex;justify-content:space-between;align-items:center;}
    .tag{padding:6px 8px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;color:var(--muted);}  
    .cooldown{font-weight:800;font-size:13px;display:flex;align-items:center;gap:8px;}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <a class="back" href="/minigames">‚Üê –ú–∏–Ω–∏–∏–≥—Ä—ã</a>
      <div class="title">
        <h1>RPG</h1>
        
      </div>
      <div style="width:64px"></div>
    </header>

    <section class="section">
      <div class="tabs">
        <div class="tab active" data-tab="gather">‚õèÔ∏è –î–æ–±—ã—á–∞</div>
        <div class="tab" data-tab="inventory">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
        <div class="tab" data-tab="conversion">‚öóÔ∏è –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</div>
        <div class="tab"><a href="/rpg-shop" style="display:flex;align-items:center;gap:8px;width:100%;justify-content:center;">üõí –ú–∞–≥–∞–∑–∏–Ω</a></div>
        <div class="tab" data-tab="profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</div>
      </div>

      <div data-view="gather">
        <div class="title-row">
          <h3 style="margin:0;font-size:16px;">–†—É—á–Ω–∞—è –¥–æ–±—ã—á–∞</h3>
          <button id="gatherBtn" class="primary-btn">–î–æ–±—ã—Ç—å</button>
        </div>
        <div class="cooldown" id="cooldownInfo">–ö–î: –≥–æ—Ç–æ–≤–æ</div>
        <div class="resource-grid" id="resourceGrid"></div>
       
      </div>

      <div data-view="inventory" style="display:none;">
        <div class="title-row" style="margin-bottom:6px;">
          <h3 style="margin:0;font-size:16px;">–†—é–∫–∑–∞–∫</h3>
        </div>
        <div class="list" id="inventoryList"></div>
      </div>

      <div data-view="conversion" style="display:none;">
        <div class="title-row" style="margin-bottom:6px;">
          <h3 style="margin:0;font-size:16px;">–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</h3>
        </div>
        <p class="muted" id="conversionInfo">5 –∫ 1 –ø–æ —Ü–µ–ø–æ—á–∫–µ: –¥–µ—Ä–µ–≤–æ ‚Üí –∫–∞–º–µ–Ω—å ‚Üí –∂–µ–ª–µ–∑–æ ‚Üí —Å–µ—Ä–µ–±—Ä–æ ‚Üí –∑–æ–ª–æ—Ç–æ ‚Üí –∫—Ä–∏—Å—Ç–∞–ª–ª ‚Üí –º–∏—Ñ—Ä–∏–ª ‚Üí —Ä–µ–ª–∏–∫—Ç ‚Üí —ç—Å—Å–µ–Ω—Ü–∏—è. –ü—Ä–æ–¥–∞–∂–∞ –≤ –æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–∑ üå† –≠—Å—Å–µ–Ω—Ü–∏–∏ –ø–æ –∫—É—Ä—Å—É 1 ‚Üí 5 –º–æ–Ω–µ—Ç.</p>
        <p class="muted" id="conversionBonus"></p>
        <div class="list" style="margin-top:10px;">
          <div class="list-item" style="flex-direction:column;align-items:stretch;gap:10px;">
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <label style="flex:1;min-width:160px;">
                <span class="muted" style="display:block;margin-bottom:4px;">–ò–∑ —Ä–µ—Å—É—Ä—Å–∞</span>
                <select id="convertFrom" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);background:var(--card);color:var(--text);">
                </select>
              </label>
              <label style="flex:1;min-width:160px;">
                <span class="muted" style="display:block;margin-bottom:4px;">–í —Ä–µ—Å—É—Ä—Å</span>
                <select id="convertTo" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);background:var(--card);color:var(--text);">
                </select>
              </label>
            </div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <button class="tab" id="convertAllBtn" style="margin:0;">–í—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ–µ</button>
              <button class="tab" id="convertPartBtn" style="margin:0;">–ß–∞—Å—Ç—å</button>
              <input id="convertAmount" type="number" min="1" value="1" style="flex:1;min-width:120px;padding:10px;border-radius:10px;border:1px solid var(--stroke);background:var(--card);color:var(--text);" />
              <button class="primary-btn" id="convertSubmit">–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å</button>
            </div>
            <p class="note" id="convertHint">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—É—Ä—Å—ã –∏ –æ–±—ä—ë–º.</p>
            <p class="note" id="convertStatus" style="color:var(--text);"></p>
          </div>
        </div>
      </div>

      <div data-view="profile" style="display:none;">
        <div class="title-row">
          <h3 style="margin:0;font-size:16px;">–ü—Ä–æ—Ñ–∏–ª—å</h3>
          <span class="tag" id="profileId">‚Äî</span>
        </div>
        <div class="list">
          <div class="list-item"><span>–ü–æ—Å–ª–µ–¥–Ω—è—è –¥–æ–±—ã—á–∞</span><span id="lastGather">‚Äî</span></div>
          <div class="list-item"><span>–í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫</span><span id="totalRuns">0</span></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    const tgInstance = initTelegramGuard();
    const RESOURCE_TYPES = [
      {key:'wood', name:'–î–µ—Ä–µ–≤–æ', icon:'ü™µ', color:'var(--green)'},
      {key:'stone', name:'–ö–∞–º–µ–Ω—å', icon:'ü™®', color:'var(--muted)'},
      {key:'iron', name:'–ñ–µ–ª–µ–∑–æ', icon:'‚õìÔ∏è', color:'var(--blue)'},
      {key:'silver', name:'–°–µ—Ä–µ–±—Ä–æ', icon:'ü•à', color:'var(--teal)'},
      {key:'gold', name:'–ó–æ–ª–æ—Ç–æ', icon:'ü™ô', color:'var(--amber)'},
      {key:'crystal', name:'–ö—Ä–∏—Å—Ç–∞–ª–ª', icon:'üîÆ', color:'var(--purple)'},
      {key:'mythril', name:'–ú–∏—Ñ—Ä–∏–ª', icon:'üßø', color:'#22d3ee'},
      {key:'relic', name:'–†–µ–ª–∏–∫—Ç', icon:'üåå', color:'#c084fc'},
      {key:'essence', name:'–≠—Å—Å–µ–Ω—Ü–∏—è', icon:'üå†', color:'#f472b6'}
    ];
    const BASE_CAP = 999;
    let convertRate = 5;
    let baseCooldown = 300;
    let convertBonus = 0;
    const CONVERT_CHAIN = {
      wood:'stone',
      stone:'iron',
      iron:'silver',
      silver:'gold',
      gold:'crystal',
      crystal:'mythril',
      mythril:'relic',
      relic:'essence'
    };
    const MIN_POINTS_RESOURCE = 'essence';

    const resourceGrid = document.getElementById('resourceGrid');
    const inventoryList = document.getElementById('inventoryList');
    const cooldownInfo = document.getElementById('cooldownInfo');
    const gatherBtn = document.getElementById('gatherBtn');
    const convertFrom = document.getElementById('convertFrom');
    const convertTo = document.getElementById('convertTo');
    const convertAmount = document.getElementById('convertAmount');
    const convertHint = document.getElementById('convertHint');
    const convertStatus = document.getElementById('convertStatus');
    const convertAllBtn = document.getElementById('convertAllBtn');
    const convertPartBtn = document.getElementById('convertPartBtn');
    const gatherNoteEl = document.getElementById('gatherNote');
    const conversionInfoEl = document.getElementById('conversionInfo');
    const conversionBonusEl = document.getElementById('conversionBonus');
    convertPartBtn.classList.add('active');

    let cooldownUntil = 0;
    let currentState = null;
    let gatherLoading = false;

    function formatCountdown(ms){
      if(ms <= 0) return '–≥–æ—Ç–æ–≤–æ';
      const totalSec = Math.ceil(ms/1000);
      const m = String(Math.floor(totalSec/60)).padStart(2,'0');
      const s = String(totalSec%60).padStart(2,'0');
      return `${m}:${s}`;
    }

    function getCap(key){
      const add = currentState?.caps?.[key] || 0;
      return BASE_CAP + add;
    }

    function updateGatherNote(){
      const minutes = Math.round((baseCooldown / 60) * 10) / 10;
      const note = `–ö–î –Ω–∞ –¥–æ–±—ã—á—É ‚Äî ${minutes} –º–∏–Ω. –ë–µ–∑ —É—Å–∏–ª–µ–Ω–∏–π –ø–∞–¥–∞—é—Ç —Ç–æ–ª—å–∫–æ ü™µ –¥–µ—Ä–µ–≤–æ, ü™® –∫–∞–º–µ–Ω—å –∏ ‚õìÔ∏è –∂–µ–ª–µ–∑–æ.`;
      if(gatherNoteEl){
        gatherNoteEl.textContent = note;
      }
    }

    function updateConversionCopy(){
        if(conversionInfoEl){
          conversionInfoEl.textContent = `${convertRate} –∫ 1 –ø–æ —Ü–µ–ø–æ—á–∫–µ: –¥–µ—Ä–µ–≤–æ ‚Üí –∫–∞–º–µ–Ω—å ‚Üí –∂–µ–ª–µ–∑–æ ‚Üí —Å–µ—Ä–µ–±—Ä–æ ‚Üí –∑–æ–ª–æ—Ç–æ ‚Üí –∫—Ä–∏—Å—Ç–∞–ª–ª ‚Üí –º–∏—Ñ—Ä–∏–ª ‚Üí —Ä–µ–ª–∏–∫—Ç ‚Üí —ç—Å—Å–µ–Ω—Ü–∏—è. –ü—Ä–æ–¥–∞–∂–∞ –≤ –æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–∑ üå† –≠—Å—Å–µ–Ω—Ü–∏–∏ –ø–æ –∫—É—Ä—Å—É 1 ‚Üí 5 –º–æ–Ω–µ—Ç.`;
        }
      if(conversionBonusEl){
        conversionBonusEl.textContent = convertBonus > 0
          ? `–ë–æ–Ω—É—Å –∞–∫—Å–µ—Å—Å—É–∞—Ä–æ–≤ –∫ –æ–±–º–µ–Ω—É: +${Math.round(convertBonus*100)}% –∫ –≤—ã—Ö–æ–¥—É.`
          : '';
      }
      updateConvertHint();
    }

    function renderResources(){
      if(!currentState) return;
      const res = currentState.resources || {};
      resourceGrid.innerHTML = '';
      inventoryList.innerHTML = '';

      RESOURCE_TYPES.forEach(r=>{
        const cap = getCap(r.key);
        const value = Math.max(0, Math.min(cap, Number(res?.[r.key] || 0)));
        const percent = Math.round((value / cap) * 100);

        const card = document.createElement('div');
        card.className = 'resource-card';
        card.innerHTML = `
          <div class="resource-head">
            <p class="resource-name">${r.icon} ${r.name}</p>
            <span class="tag">${value}/${cap}</span>
          </div>
          <div class="progress"><div class="progress-fill" style="width:${percent}%;background:${r.color};"></div></div>
          <div class="resource-row"><span>–ó–∞–ø–∞—Å</span><span>${percent}%</span></div>
        `;
        resourceGrid.appendChild(card);

        const invItem = document.createElement('div');
        invItem.className = 'list-item';
        invItem.innerHTML = `<span>${r.icon} ${r.name}</span><span>${value} / ${cap}</span>`;
        inventoryList.appendChild(invItem);
      });
    }

    function refreshConvertOptions(){
      convertFrom.innerHTML = '';
      RESOURCE_TYPES.forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r.key;
        opt.textContent = `${r.icon} ${r.name}`;
        convertFrom.appendChild(opt);
      });
      if(!convertFrom.value && RESOURCE_TYPES.length){
        convertFrom.value = RESOURCE_TYPES[0].key;
      }
      updateToOptions();
      updateConvertHint();
    }

    function updateToOptions(){
      const fromVal = convertFrom.value;
      convertTo.innerHTML = '';
      const nextRes = CONVERT_CHAIN[fromVal];
      if(nextRes){
        const resInfo = RESOURCE_TYPES.find(r=>r.key===nextRes);
        const optRes = document.createElement('option');
        optRes.value = nextRes;
        optRes.textContent = resInfo ? `${resInfo.icon} ${resInfo.name}` : nextRes;
        convertTo.appendChild(optRes);
      }
      if(canSellToPoints(fromVal)){
        const optPoints = document.createElement('option');
        optPoints.value = 'points';
        optPoints.textContent = '–û—á–∫–∏';
        convertTo.appendChild(optPoints);
      }
      convertTo.value = convertTo.options[0]?.value || 'points';
      updateConvertHint();
    }

    function calcMaxConvertible(from, to){
      const res = currentState?.resources || {};
      const have = Number(res[from] || 0);
      if(to === 'points') return canSellToPoints(from) ? have : 0;
      if(CONVERT_CHAIN[from] === to) return Math.floor(have / convertRate);
      return 0;
    }

    function updateConvertHint(){
      const fromVal = convertFrom.value;
      const toVal = convertTo.value;
      const max = calcMaxConvertible(fromVal, toVal);
      if(toVal === 'points'){
        convertHint.textContent = canSellToPoints(fromVal)
          ? `–ú–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å –¥–æ ${max} üå† –≠—Å—Å–µ–Ω—Ü–∏–∏ –∑–∞ –º–æ–Ω–µ—Ç—ã (1 ‚Üí 5).`
          : '–ü—Ä–æ–¥–∞–∂–∞ –≤ –æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–∑ üå† –≠—Å—Å–µ–Ω—Ü–∏–∏ (1 ‚Üí 5 –º–æ–Ω–µ—Ç).';
      } else {
        const bonusText = convertBonus > 0 ? ` (+${Math.round(convertBonus*100)}% –∫ –≤—ã—Ö–æ–¥—É)` : '';
        convertHint.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ –∫ –æ–±–º–µ–Ω—É: ${max} —à—Ç. (–ø–æ ${convertRate} : 1${bonusText ? '' : ''}).`;
        if(bonusText){
          convertHint.textContent += bonusText;
        }
      }
      convertStatus.textContent = '';
    }

    function fillAmountAll(){
      const max = calcMaxConvertible(convertFrom.value, convertTo.value);
      convertAmount.value = Math.max(0, max);
      convertAllBtn.classList.add('active');
      convertPartBtn.classList.remove('active');
    }

    function fillAmountPart(){
      if(!convertAmount.value || Number(convertAmount.value) <= 0){
        convertAmount.value = 1;
      }
      convertAllBtn.classList.remove('active');
      convertPartBtn.classList.add('active');
    }

    async function sendConvert(){
      const fromVal = convertFrom.value;
      const toVal = convertTo.value;
      const amount = Math.max(1, Number(convertAmount.value || 1));
      convertStatus.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
      try{
        const res = await apiPost('/api/rpg/convert', {from: fromVal, to: toVal, amount});
        if(res?.ok){
          applyState(res.state);
          convertStatus.textContent = '–ì–æ—Ç–æ–≤–æ!';
          convertAmount.value = 1;
          convertPartBtn.classList.add('active');
          convertAllBtn.classList.remove('active');
        } else if(res?.error === 'not enough resources'){
          convertStatus.textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –æ–±–º–µ–Ω–∞.';
        } else if(res?.error === 'bad convert pair'){
          convertStatus.textContent = '–ù–µ–ª—å–∑—è –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞—Ä—É.';
        } else if(res?.error === 'sell restricted'){
          convertStatus.textContent = '–ü—Ä–æ–¥–∞–∂–∞ –≤ –æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∏–∑ üå† –≠—Å—Å–µ–Ω—Ü–∏–∏ (1 ‚Üí 5 –º–æ–Ω–µ—Ç).';
        } else {
          convertStatus.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–º–µ–Ω–µ.';
        }
      }catch(e){
        convertStatus.textContent = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
      }
    }

    function canSellToPoints(resource){
      const minIdx = RESOURCE_TYPES.findIndex(r=>r.key === MIN_POINTS_RESOURCE);
      const fromIdx = RESOURCE_TYPES.findIndex(r=>r.key === resource);
      if(minIdx < 0 || fromIdx < 0) return false;
      return fromIdx >= minIdx;
    }

    function updateCooldown(){
      const remaining = cooldownUntil - Date.now();
      const ready = remaining <= 0 && !gatherLoading;
      gatherBtn.disabled = !ready;
      if(gatherLoading){
        gatherBtn.textContent = '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
      } else {
        gatherBtn.textContent = ready ? '–î–æ–±—ã—Ç—å' : `–ö–î ${formatCountdown(remaining)}`;
      }
      cooldownInfo.textContent = `–ö–î: ${formatCountdown(remaining)}`;
    }

    function renderProfile(){
      const uid = tg?.initDataUnsafe?.user?.id;
      document.getElementById('profileId').textContent = uid ? `UID: ${uid}` : '‚Äî';
    }

    function applyState(state){
      currentState = state;
      convertRate = Math.max(1, Number(state?.economy?.convert_rate || convertRate));
      baseCooldown = Math.max(30, Number(state?.economy?.base_cd || baseCooldown));
      convertBonus = Math.max(0, Number(state?.buffs?.convert_bonus || 0));
      cooldownUntil = (Number(state?.cooldown_until) || 0) * 1000;
      const totalRuns = Number(state?.stats?.total_runs || 0);
      document.getElementById('totalRuns').textContent = totalRuns;
      renderResources();
      updateCooldown();
      updateGatherNote();
      updateConversionCopy();
      refreshConvertOptions();
    }

    async function loadState(){
      gatherLoading = true;
      updateCooldown();
      try{
        const res = await apiGet('/api/rpg/state');
        if(res?.ok){
          applyState(res.state);
        } else {
          cooldownInfo.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è';
        }
      }catch(e){
        cooldownInfo.textContent = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
      } finally {
        gatherLoading = false;
        updateCooldown();
      }
    }

    async function gather(){
      const remaining = cooldownUntil - Date.now();
      if(remaining > 0 || gatherLoading) return;
      gatherLoading = true;
      updateCooldown();
      try{
        const res = await apiPost('/api/rpg/gather', {});
        if(res?.ok){
          applyState(res.state);
          const gained = res.gained || {};
          const gainedText = RESOURCE_TYPES
            .map(r=>{const v = gained[r.key]; return v ? `${r.icon} +${v}` : null;})
            .filter(Boolean)
            .join(', ');
          cooldownInfo.textContent = gainedText ? `–ü–æ–ª—É—á–µ–Ω–æ: ${gainedText}` : '–î–æ–±—ã—á–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞';
          document.getElementById('lastGather').textContent = new Date().toLocaleString();
        } else if(res?.error === 'cooldown'){
          const seconds = Number(res.cooldown_remaining || 0);
          cooldownUntil = Date.now() + seconds * 1000;
          updateCooldown();
        } else {
          cooldownInfo.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –¥–æ–±—ã—á—É';
        }
      }catch(e){
        cooldownInfo.textContent = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
      } finally {
        gatherLoading = false;
        updateCooldown();
      }
    }

    function switchTab(tab){
      document.querySelectorAll('[data-tab]').forEach(el=>{
        el.classList.toggle('active', el.dataset.tab === tab);
      });
      document.querySelectorAll('[data-view]').forEach(view=>{
        view.style.display = view.dataset.view === tab ? 'block' : 'none';
      });
    }

    document.querySelectorAll('[data-tab]').forEach(tab=>{
      tab.addEventListener('click', ()=>switchTab(tab.dataset.tab));
    });

    gatherBtn.addEventListener('click', gather);
    convertFrom.addEventListener('change', ()=>{updateToOptions(); fillAmountPart();});
    convertTo.addEventListener('change', ()=>{updateConvertHint(); fillAmountPart();});
    convertAllBtn.addEventListener('click', (e)=>{e.preventDefault(); fillAmountAll();});
    convertPartBtn.addEventListener('click', (e)=>{e.preventDefault(); fillAmountPart();});
    document.getElementById('convertSubmit').addEventListener('click', (e)=>{e.preventDefault(); sendConvert();});
    renderProfile();
    updateGatherNote();
    updateConversionCopy();
    setInterval(updateCooldown, 1000);

    (async () => {
      if(!tgInstance) return;
      const profile = await ensureNicknameOrRedirect();
      if(!profile || !profile.ok) return;
      await loadState();
    })();
  </script>
</body>
</html>
