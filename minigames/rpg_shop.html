<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RPG –ú–∞–≥–∞–∑–∏–Ω ‚Äî FirstClub</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/webapp_guard.js"></script>
  <style>
    :root{
      --bg:#0a0d12;--bg2:#0e1117;--panel:#0d1117;--card:#111722;--card2:#0f1520;
      --stroke:rgba(255,255,255,.06);--stroke2:rgba(100,160,255,.25);
      --blue:#3b82f6;--blue2:#1d4ed8;--text:#e6edf3;--muted:#98a2b3;
      --green:#22c55e;--amber:#f59e0b;--purple:#a855f7;--teal:#14b8a6;
      --shadow:0 0 0 1px var(--stroke),0 8px 30px rgba(0,0,0,.6);
    }
    html[data-theme="light"]{
      --bg:#f4f7fb;--bg2:#eef2f7;--panel:#ffffff;--card:#ffffff;--card2:#f6f8fb;
      --stroke:rgba(10,20,40,.08);--stroke2:rgba(59,130,246,.35);
      --blue:#2563eb;--blue2:#1d4ed8;--text:#0b1220;--muted:#52607a;
      --green:#16a34a;--amber:#d97706;--purple:#9333ea;--teal:#0d9488;
      --shadow:0 0 0 1px var(--stroke),0 10px 26px rgba(10,20,40,.08);
    }
    html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-overflow-scrolling:auto;touch-action:manipulation;}
    *{box-sizing:border-box;}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background:radial-gradient(1000px 600px at 10% -10%,rgba(59,130,246,.28),transparent 60%),
      radial-gradient(800px 500px at 110% 0%,rgba(29,78,216,.22),transparent 55%),
      linear-gradient(180deg,var(--bg2) 0%,var(--bg) 100%);
      min-height:100vh;display:flex;justify-content:center;padding:16px;
    }
    .app{position:relative;width:min(900px,100%);border:1px solid var(--stroke);border-radius:20px;box-shadow:var(--shadow);padding:14px;
      background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));height:100%;overflow-y:auto;overscroll-behavior:none;}
    header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px 14px;gap:10px;}
    .title{display:flex;flex-direction:column;gap:2px;align-items:flex-start;}
    .title h1{margin:0;font-size:20px;font-weight:800;}
    .title span{font-size:12px;color:var(--muted);}
    .back{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
      border:1px solid var(--stroke);color:var(--text);text-decoration:none;font-weight:700;font-size:14px;cursor:pointer;transition:.15s ease;}
    .back:hover{border-color:var(--stroke2);transform:translateY(-1px);}
    .section{background:linear-gradient(180deg,var(--panel) 0%,color-mix(in oklab,var(--panel) 92%,transparent) 100%);border:1px solid var(--stroke);
      border-radius:16px;padding:16px;box-shadow:var(--shadow);}
    .tabs{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:12px;}
    .tab{padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
      font-weight:800;font-size:13px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:.15s ease;justify-content:center;}
    .tab.active{border-color:var(--stroke2);box-shadow:0 6px 20px rgba(59,130,246,.22);color:var(--blue);background:linear-gradient(180deg,color-mix(in oklab,var(--card) 90%,var(--stroke2)) 0%,var(--card2) 100%);}
    .tab:hover{border-color:var(--stroke2);}
    .muted{color:var(--muted);font-size:13px;margin:0;line-height:1.45;text-align:center;}
    .placeholder{border:1px dashed var(--stroke);border-radius:12px;padding:18px;text-align:center;background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
      box-shadow:var(--shadow);}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--stroke2);color:var(--text);background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);font-weight:800;width:max-content;}
    .card{border:1px solid var(--stroke);border-radius:14px;padding:12px;background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px;}
    .card-title{margin:0;font-size:15px;font-weight:900;display:flex;gap:6px;align-items:center;}
    .card-desc{margin:0;font-size:13px;color:var(--muted);}
    .card-meta{font-size:12px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;}
    .card-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .inline-badge{padding:6px 8px;border-radius:999px;border:1px solid var(--stroke);font-size:12px;color:var(--muted);}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--stroke2);background:linear-gradient(180deg,var(--blue) 0%,var(--blue2) 100%);color:white;font-weight:800;cursor:pointer;}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <a class="back" href="/rpg">‚Üê RPG</a>
      <div class="title">
        <h1>–ú–∞–≥–∞–∑–∏–Ω RPG</h1>
        <span>–ü–æ–¥–±–æ—Ä–∫–∏ —É—Å–∏–ª–µ–Ω–∏–π –∏ —É–ª—É—á—à–µ–Ω–∏–π</span>
      </div>
      <div id="balancePill" class="pill">–ë–∞–ª–∞–Ω—Å: ‚Äî</div>
    </header>

    <section class="section">
      <div class="tabs">
        <div class="tab active" data-tab="auto">ü§ñ –ê–≤—Ç–æ-–¥–æ–±—ã—Ç—á–∏–∫–∏</div>
        <div class="tab" data-tab="storage">üì¶ –•—Ä–∞–Ω–∏–ª–∏—â–∞</div>
        <div class="tab" data-tab="tools">üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
        <div class="tab" data-tab="accessories">üéóÔ∏è –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</div>
      </div>

      <div data-view="auto">
        <div id="autoList" class="list"></div>
      </div>

      <div data-view="storage" style="display:none;">
        <div id="storageList" class="list"></div>
      </div>

      <div data-view="tools" style="display:none;">
        <div id="toolsList" class="list"></div>
      </div>

      <div data-view="accessories" style="display:none;">
        <div id="accList" class="list"></div>
      </div>
    </section>
  </div>

  <script>
    const tgInstance = initTelegramGuard();
    const storageList = document.getElementById('storageList');
    const autoList = document.getElementById('autoList');
    const toolsList = document.getElementById('toolsList');
    const accList = document.getElementById('accList');
    const balancePill = document.getElementById('balancePill');

    const RESOURCE_TYPES = [
      {key:'wood', name:'–î–µ—Ä–µ–≤–æ', icon:'ü™µ'},
      {key:'stone', name:'–ö–∞–º–µ–Ω—å', icon:'ü™®'},
      {key:'iron', name:'–ñ–µ–ª–µ–∑–æ', icon:'‚õìÔ∏è'},
      {key:'silver', name:'–°–µ—Ä–µ–±—Ä–æ', icon:'ü•à'},
      {key:'gold', name:'–ó–æ–ª–æ—Ç–æ', icon:'ü™ô'},
      {key:'crystal', name:'–ö—Ä–∏—Å—Ç–∞–ª–ª', icon:'üîÆ'},
      {key:'mythril', name:'–ú–∏—Ñ—Ä–∏–ª', icon:'üßø'},
      {key:'relic', name:'–†–µ–ª–∏–∫—Ç', icon:'üåå'},
      {key:'essence', name:'–≠—Å—Å–µ–Ω—Ü–∏—è', icon:'üå†'},
    ];
    const RESOURCE_MAP = Object.fromEntries(RESOURCE_TYPES.map(r=>[r.key,r]));

    function formatCost(cost){
      if(!cost || !Object.keys(cost).length) return '';
      return Object.entries(cost).map(([k,v])=>{
        const resInfo = RESOURCE_MAP[k] || {};
        return `${resInfo.icon || ''} ${resInfo.name || k} ‚Äî ${v}`;
      }).join(', ');
    }

    const BAG_ITEMS = [
      {id:'bag1', name:'–ú–µ—à–æ–∫ –∏–∑ —Ç–∫–∞–Ω–∏', cost:3, costRes:'wood', cap:80},
      {id:'bag2', name:'–°—É–º–∫–∞ —Å—Ç–∞—Ä–∞—Ç–µ–ª—è', cost:6, costRes:'wood', cap:160},
      {id:'bag3', name:'–†—é–∫–∑–∞–∫ —à–∞—Ö—Ç—ë—Ä–∞', cost:12, costRes:'stone', cap:320},
      {id:'bag4', name:'–£–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ä—é–∫–∑–∞–∫', cost:18, costRes:'stone', cap:520},
      {id:'bag5', name:'–≠–∫—Å–ø–µ–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –º–µ—à–æ–∫', cost:25, costRes:'iron', cap:800},
      {id:'bag6', name:'–ö–∞—Ä–∫–∞—Å–Ω–∞—è —Å—É–º–∫–∞', cost:33, costRes:'iron', cap:1100},
      {id:'bag7', name:'–ì–æ—Ä–Ω—ã–π –±–∞—É–ª', cost:42, costRes:'silver', cap:1500},
      {id:'bag8', name:'–°—É–º–∫–∞ –∏–Ω–∂–µ–Ω–µ—Ä–∞', cost:55, costRes:'silver', cap:1900},
      {id:'bag9', name:'–ê—Ä—Ç–µ—Ñ–∞–∫—Ç–Ω—ã–π —Ä—é–∫–∑–∞–∫', cost:70, costRes:'gold', cap:2500},
      {id:'bag10', name:'–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä', cost:95, costRes:'gold', cap:3200},
      {id:'bag11', name:'–ü–æ–ª–µ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä', cost:125, costRes:'crystal', cap:4200},
      {id:'bag12', name:'–°—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–Ω–µ—Ü', cost:160, costRes:'crystal', cap:5400},
      {id:'bag13', name:'–ê—Å—Ç–µ—Ä–æ–∏–¥–Ω—ã–π –±–æ–∫—Å', cost:200, costRes:'mythril', cap:7000},
      {id:'bag14', name:'–ö–≤–∞–Ω—Ç–æ–≤—ã–π —Ä—é–∫–∑–∞–∫', cost:250, costRes:'relic', cap:8800},
      {id:'bag15', name:'–•—Ä–∞–Ω–∏–ª–∏—â–µ –ø–µ—Ä–≤–æ–ø—Ä–æ—Ö–æ–¥—Ü–∞', cost:310, costRes:'essence', cap:11000},
      {id:'bag16', name:'–≠–∫–∑–æ–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä', cost:380, costRes:'essence', cap:14000},
      {id:'bag17', name:'–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–π –æ—Ç—Å–µ–∫', cost:460, costRes:'essence', cap:17000},
      {id:'bag18', name:'–°—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–∞—Ä–º–∞–Ω', cost:550, costRes:'essence', cap:20000},
      {id:'bag19', name:'–ê—Ä—Ö–∏–≤ —Ä–µ–ª–∏–∫—Ç–æ–≤', cost:650, costRes:'essence', cap:24000},
      {id:'bag20', name:'–ö–æ–Ω—Ç–∏–Ω—É—É–º-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ', cost:780, costRes:'essence', cap:28000},
    ];

    const TOOL_ITEMS = [
      {id:'tool1', name:'–ö–∏—Ä–∫–∞ –Ω–æ–≤–∏—á–∫–∞', cost:3, costRes:'wood', chance:5, cd:0, resource:'wood', desc:'–î–∞—ë—Ç —à–∞–Ω—Å –Ω–∞–π—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –¥–µ—Ä–µ–≤–æ.'},
      {id:'tool2', name:'–ö–∞–º–µ–Ω–Ω—ã–π –¥–æ–ª–æ—Ç', cost:6, costRes:'stone', chance:8, cd:3, resource:'stone', desc:'–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–∞–º–µ–Ω—å –ø—Ä–∏ —É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–µ.'},
      {id:'tool3', name:'–ñ–µ–ª–µ–∑–Ω–∞—è –∫–∏—Ä–∫–∞', cost:10, costRes:'iron', chance:10, cd:5, resource:'iron', desc:'–®–∞–Ω—Å –≤—ã–±–∏—Ç—å –ª–∏—à–Ω—é—é –∂–µ–ª–µ–∑–Ω—É—é –∂–∏–ª—É.'},
      {id:'tool4', name:'–°–µ—Ä–µ–±—Ä—è–Ω–∞—è –∫–∏—Ä–∫–∞', cost:15, costRes:'silver', chance:12, cd:7, resource:'silver', desc:'–ü–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å —Ä–µ–¥–∫–æ–µ —Å–µ—Ä–µ–±—Ä–æ.'},
      {id:'tool5', name:'–ó–æ–ª–æ—Ç–∞—è –¥—Ä–µ–ª—å', cost:21, costRes:'gold', chance:15, cd:9, resource:'gold', desc:'–®–∞–Ω—Å –Ω–∞ –±–æ–Ω—É—Å–Ω–æ–µ –∑–æ–ª–æ—Ç–æ –ø—Ä–∏ –¥–æ–±—ã—á–µ.'},
      {id:'tool6', name:'–ö—Ä–∏—Å—Ç–∞–ª—å–Ω—ã–π —Ä–µ–∑–∞–∫', cost:28, costRes:'crystal', chance:18, cd:11, resource:'crystal', desc:'–£—Å–∫–æ—Ä—è–µ—Ç –ø–æ–∏—Å–∫ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤.'},
      {id:'tool7', name:'–ú–∏—Ñ—Ä–∏–ª–æ–≤—ã–π –±—É—Ä', cost:36, costRes:'mythril', chance:22, cd:13, resource:'mythril', desc:'–®–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å –º–∏—Ñ—Ä–∏–ª —Å –¥–æ–±—ã—á–∏.'},
      {id:'tool8', name:'–†–µ–ª–∏–∫—Ç–æ–≤—ã–π —ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä', cost:45, costRes:'relic', chance:26, cd:15, resource:'relic', desc:'–ú–∞–ª—ã–π —à–∞–Ω—Å –¥–æ—Å—Ç–∞—Ç—å —Ä–µ–ª–∏–∫—Ç –ø—Ä–∏ –¥–æ–±—ã—á–µ.'},
    ];

    const ACCESSORY_ITEMS = [
      {id:'acc1', name:'–¢–∫–∞–Ω–µ–≤–∞—è –ø–æ–¥–≤—è–∑–∫–∞', level:1, cost:4, costRes:'wood', cd:3, convert:2},
      {id:'acc2', name:'–ñ–µ—Ç–æ–Ω —Å—Ç–∞—Ä–∞—Ç–µ–ª—è', level:2, cost:7, costRes:'stone', cd:5, convert:4},
      {id:'acc3', name:'–ö–æ–ª—å—Ü–æ —É—Å–∫–æ—Ä–µ–Ω–∏—è', level:3, cost:11, costRes:'iron', cd:7, convert:6},
      {id:'acc4', name:'–ê–º—É–ª–µ—Ç —Ä—É–¥—ã', level:4, cost:15, costRes:'silver', cd:10, convert:8},
      {id:'acc5', name:'–ë—Ä–∞—Å–ª–µ—Ç –∏–Ω–∂–µ–Ω–µ—Ä–∞', level:5, cost:21, costRes:'gold', cd:12, convert:10},
      {id:'acc6', name:'–§–∞–∑–æ–≤—ã–π —Ç–∞–ª–∏—Å–º–∞–Ω', level:6, cost:28, costRes:'crystal', cd:15, convert:12},
      {id:'acc7', name:'–ü–µ—á–∞—Ç—å —Ä–µ–ª–∏–∫—Ç–æ–≤', level:7, cost:36, costRes:'mythril', cd:18, convert:15},
      {id:'acc8', name:'–ö–æ—Ä–æ–Ω–∞ –∞–ª—Ö–∏–º–∏–∫–∞', level:8, cost:45, costRes:'relic', cd:22, convert:18},
    ];

    let currentState = null;
    function switchTab(tab){
      document.querySelectorAll('[data-tab]').forEach(el=>{
        el.classList.toggle('active', el.dataset.tab === tab);
      });
      document.querySelectorAll('[data-view]').forEach(view=>{
        view.style.display = view.dataset.view === tab ? 'block' : 'none';
      });
    }

    function renderBalance(){
      const bal = currentState?.balance ?? '‚Äî';
      balancePill.textContent = `–ë–∞–ª–∞–Ω—Å: ${bal}`;
    }

    async function buyItem(category, item_id){
      const res = await apiPost('/api/rpg/buy', {category, item_id});
      if(res?.ok){
        currentState = res.state;
        renderAll();
      }
    }

    function renderBags(){
      storageList.innerHTML = '';
      if(!currentState){
        storageList.innerHTML = '<div class="placeholder"><p class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
        return;
      }
      const owned = new Set(currentState?.owned?.bags || []);
      const resources = currentState?.resources || {};
      const available = BAG_ITEMS.filter(b=>!owned.has(b.id));
      if(!available.length){
        storageList.innerHTML = '<div class="placeholder"><p class="muted">–í—Å–µ —Ä—é–∫–∑–∞–∫–∏ —É–∂–µ –∫—É–ø–ª–µ–Ω—ã.</p></div>';
        return;
      }
      available.forEach(b=>{
        const el = document.createElement('div');
        el.className = 'card';
        const resInfo = RESOURCE_MAP[b.costRes] || {};
        const have = Number(resources[b.costRes] || 0);
        const canBuy = have >= b.cost;
        el.innerHTML = `
          <p class="card-title">üéí ${b.name}</p>
          <p class="card-desc">+${b.cap} –∫ –ª–∏–º–∏—Ç—É –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞.</p>
          <div class="card-meta">
            <span class="inline-badge">–¶–µ–Ω–∞: ${resInfo.icon || ''} ${resInfo.name || b.costRes} ‚Äî ${b.cost}</span>
            <span class="inline-badge">–í –Ω–∞–ª–∏—á–∏–∏: ${have}</span>
            <span class="inline-badge">–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${b.cap}</span>
          </div>
        `;
        const actions = document.createElement('div');
        actions.className = 'card-actions';
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.disabled = !canBuy;
        btn.textContent = canBuy ? '–ö—É–ø–∏—Ç—å' : '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤';
        btn.addEventListener('click', ()=>buyItem('bags', b.id));
        actions.appendChild(btn);
        el.appendChild(actions);
        storageList.appendChild(el);
      });
    }

    function renderTools(){
      toolsList.innerHTML = '';
      if(!currentState){
        toolsList.innerHTML = '<div class="placeholder"><p class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
        return;
      }
      const owned = new Set(currentState?.owned?.tools || []);
      const resources = currentState?.resources || {};
      TOOL_ITEMS.forEach(t=>{
        const resKey = t.costRes || t.resource;
        const resInfo = RESOURCE_MAP[resKey] || {};
        const have = Number(resources[resKey] || 0);
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <p class="card-title">üõ†Ô∏è ${t.name}</p>
          <p class="card-desc">${t.desc}</p>
          <div class="card-meta">
            <span class="inline-badge">–®–∞–Ω—Å +${t.chance}% –Ω–∞ ${resInfo.icon || ''} ${resInfo.name || t.resource}</span>
            <span class="inline-badge">–°–æ–∫—Ä–∞—â–µ–Ω–∏–µ –ö–î: ${(t.cd || 0)}%</span>
            <span class="inline-badge">–¶–µ–Ω–∞: ${resInfo.icon || ''} ${resInfo.name || resKey} ‚Äî ${t.cost}</span>
            <span class="inline-badge">–í –Ω–∞–ª–∏—á–∏–∏: ${have}</span>
          </div>
        `;
        const actions = document.createElement('div');
        actions.className = 'card-actions';
        const btn = document.createElement('button');
        btn.className = 'btn';
        const canBuy = have >= t.cost;
        if(owned.has(t.id)){
          btn.textContent = '–ö—É–ø–ª–µ–Ω–æ';
          btn.disabled = true;
        } else {
          btn.textContent = canBuy ? `–ö—É–ø–∏—Ç—å –∑–∞ ${t.cost} ${resInfo.icon || ''}` : '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤';
          btn.disabled = !canBuy;
          btn.addEventListener('click', ()=>buyItem('tools', t.id));
        }
        actions.appendChild(btn);
        el.appendChild(actions);
        toolsList.appendChild(el);
      });
    }

    function renderAccessories(){
      accList.innerHTML = '';
      if(!currentState){
        accList.innerHTML = '<div class="placeholder"><p class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
        return;
      }
      const owned = new Set(currentState?.owned?.acc || []);
      const resources = currentState?.resources || {};
      ACCESSORY_ITEMS.forEach(a=>{
        const resKey = a.costRes;
        const resInfo = RESOURCE_MAP[resKey] || {};
        const have = Number(resources[resKey] || 0);
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <p class="card-title">üéóÔ∏è –£—Ä–æ–≤–µ–Ω—å ${a.level}: ${a.name}</p>
          <p class="card-desc">–°–Ω–∏–∂–∞–µ—Ç –ö–î –∏ —É—Å–∏–ª–∏–≤–∞–µ—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é —Ä–µ—Å—É—Ä—Å–æ–≤.</p>
          <div class="card-meta">
            <span class="inline-badge">‚àí${a.cd}% –∫ –ö–î –¥–æ–±—ã—á–∏</span>
            <span class="inline-badge">+${a.convert}% –∫ –æ–±—ä—ë–º—É –æ–±–º–µ–Ω–∞</span>
            <span class="inline-badge">–¶–µ–Ω–∞: ${resInfo.icon || ''} ${resInfo.name || resKey} ‚Äî ${a.cost}</span>
            <span class="inline-badge">–í –Ω–∞–ª–∏—á–∏–∏: ${have}</span>
          </div>
        `;
        const actions = document.createElement('div');
        actions.className = 'card-actions';
        const btn = document.createElement('button');
        btn.className = 'btn';
        const canBuy = have >= a.cost;
        if(owned.has(a.id)){
          btn.textContent = '–ö—É–ø–ª–µ–Ω–æ';
          btn.disabled = true;
        } else {
          btn.textContent = canBuy ? `–ö—É–ø–∏—Ç—å –∑–∞ ${a.cost} ${resInfo.icon || ''}` : '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤';
          btn.disabled = !canBuy;
          btn.addEventListener('click', ()=>buyItem('acc', a.id));
        }
        actions.appendChild(btn);
        el.appendChild(actions);
        accList.appendChild(el);
      });
    }

    function renderAuto(){
      autoList.innerHTML = '';
      const miners = currentState?.auto?.miners || [];
      if(!miners.length){
        autoList.innerHTML = '<div class="placeholder"><p class="muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–±—ã—Ç—á–∏–∫–æ–≤.</p></div>';
        return;
      }
      miners.forEach(m=>{
        const el = document.createElement('div');
        el.className = 'card';
        const resInfo = RESOURCE_MAP[m.resource] || {};
        const bagName = BAG_ITEMS.find(b=>b.id === m.bag_req)?.name || m.bag_req;
        const levelText = m.level > 0 ? `–£—Ä–æ–≤–µ–Ω—å ${m.level}/${m.max_level}` : `–ù–µ–∞–∫—Ç–∏–≤–µ–Ω (0/${m.max_level})`;
        const productionLine = m.level > 0
          ? `+${m.rate} ${resInfo.name || m.resource} –∫–∞–∂–¥—ã–µ ${m.interval} —Å–µ–∫.`
          : `–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: +${m.preview_rate || m.rate} ${resInfo.name || m.resource} –∫–∞–∂–¥—ã–µ ${m.preview_interval || m.interval || '?'} —Å–µ–∫.`;
        const upgradeCost = formatCost(m.upgrade_cost);
        const missingUpgrade = formatCost(m.missing_upgrade || {});
        const badgeText = m.active ? '–†–∞–±–æ—Ç–∞–µ—Ç' : (m.can_start ? '–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É' : (m.has_bag ? '–ù—É–∂–Ω–æ —É–ª—É—á—à–µ–Ω–∏–µ' : '–ù—É–∂–µ–Ω —Ä—é–∫–∑–∞–∫'));
        el.innerHTML = `
          <p class="card-title">ü§ñ ${m.name}</p>
          <p class="card-desc">${productionLine}</p>
          <div class="card-meta">
            <span class="inline-badge">${badgeText}</span>
            ${m.bag_req ? `<span class="inline-badge">–ù—É–∂–µ–Ω: ${bagName}</span>` : ''}
            <span class="inline-badge">${levelText}</span>
          </div>
          <p class="card-desc">${upgradeCost ? `–°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏—è: ${upgradeCost}` : '–î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å.'}</p>
          ${upgradeCost ? `<p class="card-desc muted">${(m.missing_upgrade && Object.keys(m.missing_upgrade).length) ? '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç: ' + missingUpgrade : '–†–µ—Å—É—Ä—Å–æ–≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞.'}</p>` : ''}
        `;
        const actions = document.createElement('div');
        actions.className = 'card-actions';
        const startBtn = document.createElement('button');
        startBtn.className = 'btn';
        if(m.active){
          startBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
          startBtn.addEventListener('click', ()=>toggleAuto(m.id, 'stop'));
        } else {
          const reason = !m.has_bag ? '–ù—É–∂–µ–Ω –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ä—é–∫–∑–∞–∫' : (m.level <= 0 ? '–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–∫–∞—á–∞–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å' : '');
          startBtn.textContent = m.can_start ? '–ó–∞–ø—É—Å—Ç–∏—Ç—å' : (reason || '–¢—Ä–µ–±—É—é—Ç—Å—è —É—Å–ª–æ–≤–∏—è');
          startBtn.disabled = !m.can_start;
          startBtn.title = reason;
          startBtn.addEventListener('click', ()=>m.can_start && toggleAuto(m.id, 'start'));
        }
        actions.appendChild(startBtn);

        const upgradeBtn = document.createElement('button');
        upgradeBtn.className = 'btn ghost';
        if(!m.upgrade_cost){
          upgradeBtn.textContent = '–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å';
          upgradeBtn.disabled = true;
        } else {
          const targetLevel = m.next_level || (m.level + 1);
          upgradeBtn.textContent = m.can_upgrade ? `–£–ª—É—á—à–∏—Ç—å –¥–æ ${targetLevel} —É—Ä.` : '–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ä–µ—Å—É—Ä—Å–æ–≤';
          upgradeBtn.disabled = !m.can_upgrade;
          upgradeBtn.addEventListener('click', ()=>upgradeAuto(m.id));
        }
        actions.appendChild(upgradeBtn);
        el.appendChild(actions);
        autoList.appendChild(el);
      });
    }

    async function upgradeAuto(miner_id){
      const res = await apiPost('/api/rpg/auto', {miner_id, action:'upgrade'});
      if(res?.ok){
        currentState = res.state;
        renderAll();
      }
    }

    async function toggleAuto(miner_id, action){
      const res = await apiPost('/api/rpg/auto', {miner_id, action});
      if(res?.ok){
        currentState = res.state;
        renderAll();
      }
    }

    function renderAll(){
      renderBalance();
      renderBags();
      renderAuto();
      renderTools();
      renderAccessories();
    }

    async function loadState(){
      const res = await apiGet('/api/rpg/state');
      if(res?.ok){
        currentState = res.state;
        renderAll();
      }
    }

    document.querySelectorAll('[data-tab]').forEach(tab=>{
      tab.addEventListener('click', ()=>switchTab(tab.dataset.tab));
    });

    (async ()=>{
      if(!tgInstance) return;
      const profile = await ensureNicknameOrRedirect();
      if(!profile || !profile.ok) return;
      await loadState();
    })();
  </script>
</body>
</html>
