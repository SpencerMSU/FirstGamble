<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Выбор никнейма — FirstClub</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="/webapp_guard.js"></script>
<style>
:root{--bg:#0a0d12;--bg2:#0e1117;--panel:#0d1117;--card:#111722;--card2:#0f1520;--stroke:rgba(255,255,255,.06);--stroke2:rgba(100,160,255,.25);--blue:#3b82f6;--blue2:#1d4ed8;--text:#e6edf3;--muted:#98a2b3;--shadow:0 0 0 1px var(--stroke),0 8px 30px rgba(0,0,0,.6);} 
html[data-theme="light"]{--bg:#f4f7fb;--bg2:#eef2f7;--panel:#fff;--card:#fff;--card2:#f6f8fb;--stroke:rgba(10,20,40,.08);--stroke2:rgba(59,130,246,.35);--blue:#2563eb;--blue2:#1d4ed8;--text:#0b1220;--muted:#52607a;--shadow:0 0 0 1px var(--stroke),0 10px 26px rgba(10,20,40,.08);} 
html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-overflow-scrolling:auto;touch-action:manipulation;}*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:
radial-gradient(1000px 600px at 10% -10%,rgba(59,130,246,.28),transparent 60%),
radial-gradient(800px 500px at 110% 0%,rgba(29,78,216,.22),transparent 55%),
linear-gradient(180deg,var(--bg2) 0%,var(--bg) 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:16px;}
.app{width:min(520px,100%);border:1px solid var(--stroke);border-radius:20px;box-shadow:var(--shadow);padding:18px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));}
.card{background:linear-gradient(180deg,var(--panel) 0%,color-mix(in oklab,var(--panel) 90%,transparent) 100%);border:1px solid var(--stroke);border-radius:16px;padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px;}
.card h1{margin:0;font-size:22px;font-weight:900;}
.card p{margin:0;font-size:14px;color:var(--muted);line-height:1.6;}
.field{display:flex;flex-direction:column;gap:8px;}
label{font-weight:800;font-size:14px;}
input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);color:var(--text);font-size:15px;font-weight:700;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.03);} 
input[type="text"]:focus{border-color:var(--stroke2);}
.error{color:#f87171;font-size:13px;min-height:18px;font-weight:700;}
button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke2);background:linear-gradient(180deg,var(--blue) 0%,var(--blue2) 100%);color:white;font-weight:900;font-size:15px;cursor:pointer;transition:.15s;} 
button:disabled{opacity:.6;cursor:not-allowed;filter:saturate(.5);} 
.note{font-size:13px;color:var(--muted);} 
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>Выбор никнейма</h1>
    <p>Никнейм будет отображаться в рейтинге и внутри FirstClub. Его увидят другие участники клуба.</p>
    <div class="field">
      <label for="nickInput">Твой никнейм</label>
      <input id="nickInput" type="text" placeholder="Например, LuckyFox" maxlength="20" autocomplete="off" />
      <div id="error" class="error"></div>
    </div>
    <button id="saveBtn" disabled>Сохранить и продолжить</button>
    <div class="note">Разрешены латинские буквы, цифры, подчёркивание и дефис. Длина 3–20 символов.</div>
  </div>
</div>

<script>
const tgInstance = initTelegramGuard();
const searchUid = new URLSearchParams(window.location.search).get("uid");
let uid = null;

function getTgUserId(){
  try{ return tg?.initDataUnsafe?.user?.id || null; }catch(e){ return null; }
}

try{
  uid = getTgUserId() || searchUid;
}catch(e){
  uid = searchUid;
}

const input = document.getElementById("nickInput");
const errorEl = document.getElementById("error");
const saveBtn = document.getElementById("saveBtn");
const reNick = /^[A-Za-z0-9_-]{3,20}$/;
const SAVE_TEXT = "Сохранить и продолжить";
const LOADING_TEXT = "Сохраняем...";

function redirectHome(){
  const query = uid ? `?uid=${uid}` : "";
  window.location.href = "/" + query;
}

function validate(){
  const val = (input.value || "").trim();
  if(!val){
    errorEl.textContent = "Введите никнейм";
    saveBtn.disabled = true;
    return null;
  }
  if(!reNick.test(val)){
    errorEl.textContent = "3–20 символов: буквы, цифры, _ или -";
    saveBtn.disabled = true;
    return null;
  }
  errorEl.textContent = "";
  saveBtn.disabled = false;
  return val;
}

// Обновляем состояние кнопки при любых изменениях поля, включая автозаполнение
["input", "change", "blur"].forEach(evt => input.addEventListener(evt, validate));
validate();

async function save(){
  const nick = validate();
  if(!nick) return;
  saveBtn.disabled = true;
  saveBtn.textContent = LOADING_TEXT;
  try{
    const res = await apiPost("/api/profile", {name: nick});
    if(res && res.ok){
      try{ tg?.showAlert?.("Никнейм сохранён!"); }catch(e){}
      redirectHome();
      return;
    }
    const message = res?.error || "Не удалось сохранить";
    errorEl.textContent = message;
    throw new Error(message);
  }catch(e){
    console.error("Nickname save failed", e);
    saveBtn.disabled = false;
    saveBtn.textContent = SAVE_TEXT;
    tg?.showAlert?.(String(e?.message || e));
  }
}

saveBtn.addEventListener("click", save);

(async () => {
  if(!tgInstance) return;
  const profile = await fetchProfile();
  if(profile && profile.ok && (profile.name||"").trim()){
    redirectHome();
    return;
  }
  validate();
})();
</script>
</body>
</html>
