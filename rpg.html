<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPG ‚Äî FirstClub</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="/webapp_guard.js"></script>
<style>
:root{
  --bg:#0a0d12;--bg2:#0e1117;--panel:#0d1117;--card:#111722;--card2:#0f1520;
  --stroke:rgba(255,255,255,.06);--stroke2:rgba(100,160,255,.25);
  --blue:#3b82f6;--blue2:#1d4ed8;--text:#e6edf3;--muted:#98a2b3;
  --green:#22c55e;--red:#ef4444;--amber:#f59e0b;
  --shadow:0 0 0 1px var(--stroke),0 8px 30px rgba(0,0,0,.6);
  --radius:18px;
}
  html[data-theme="light"]{
    --bg:#f4f7fb;--bg2:#eef2f7;--panel:#fff;--card:#fff;--card2:#f6f8fb;
    --stroke:rgba(10,20,40,.08);--stroke2:rgba(59,130,246,.35);
    --blue:#2563eb;--blue2:#1d4ed8;--text:#0b1220;--muted:#52607a;
    --shadow:0 0 0 1px var(--stroke),0 10px 26px rgba(10,20,40,.08);
  }
  html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-overflow-scrolling:auto;touch-action:manipulation;}
  *{box-sizing:border-box}
  body{
    margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
    background:
      radial-gradient(1000px 600px at 10% -10%, rgba(59,130,246,.28), transparent 60%),
    radial-gradient(800px 500px at 110% 0%, rgba(29,78,216,.22), transparent 55%),
    linear-gradient(180deg,var(--bg2) 0%,var(--bg) 100%);
  min-height:100vh;display:flex;justify-content:center;padding:16px;
}
  .app{
    width:min(1000px,100%);
    border:1px solid var(--stroke);border-radius:20px;box-shadow:var(--shadow);padding:14px;
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
    height:100%;overflow-y:auto;overscroll-behavior:none;
  }
  .gate{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:rgba(0,0,0,.6);backdrop-filter:blur(6px);z-index:20;padding:16px;
  }
  .gate-card{
    width:min(340px,100%);
    background:linear-gradient(180deg,var(--panel),var(--card));
    border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);
    padding:16px;display:flex;flex-direction:column;gap:10px;align-items:stretch;
  }
  .gate-title{font-weight:900;font-size:18px;}
  .gate-text{font-size:13px;color:var(--muted);}
  .gate-input{
    padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
    background:linear-gradient(180deg,var(--card),var(--card2));color:var(--text);
    font-weight:800;font-size:14px;
  }
  .gate-btn{
    padding:11px 12px;border-radius:12px;border:1px solid var(--stroke2);
    background:linear-gradient(180deg,var(--blue),var(--blue2));color:white;font-weight:900;
    cursor:pointer;
  }
  .gate-error{color:var(--red);font-size:12px;min-height:14px;}
  .container,.content{height:100%;overflow-y:auto;overscroll-behavior:none;}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px 14px;gap:10px;}
.title{display:flex;flex-direction:column;gap:2px;align-items:center;flex:1;}
.title h1{margin:0;font-size:20px;font-weight:800;}
.title span{font-size:12px;color:var(--muted);}
.back{
  display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  border:1px solid var(--stroke);color:var(--text);text-decoration:none;font-weight:700;font-size:14px;cursor:pointer;transition:.15s ease;
}
.back:hover{border-color:var(--stroke2);transform:translateY(-1px);}
.balance-pill{
  display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  border:1px solid var(--stroke);font-weight:800;font-size:14px;min-width:88px;justify-content:center;
}
.section{background:linear-gradient(180deg,var(--panel),transparent);border:1px solid var(--stroke);border-radius:var(--radius);padding:12px;margin-bottom:12px;}
.tabs{display:flex;gap:8px;flex-wrap:wrap;}
.tab{
  padding:7px 10px;border-radius:10px;border:1px solid var(--stroke);
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  font-weight:800;font-size:12px;cursor:pointer;user-select:none;transition:.15s;
}
.tab.active{border-color:var(--stroke2);box-shadow:0 0 0 2px rgba(59,130,246,.12) inset;}
.bigbtn{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke2);cursor:pointer;
  background:linear-gradient(180deg,var(--blue) 0%,var(--blue2) 100%);color:white;font-weight:900;font-size:15px;
  display:flex;align-items:center;justify-content:center;gap:8px;transition:.15s;
}
.bigbtn:disabled{opacity:.6;cursor:not-allowed;filter:saturate(.5);}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
@media (max-width:720px){.grid2{grid-template-columns:1fr;}}
.res-card{
  border:1px solid var(--stroke);border-radius:12px;padding:10px;background:linear-gradient(180deg,var(--card),var(--card2));
  display:flex;flex-direction:column;gap:6px;
}
.res-row{display:flex;justify-content:space-between;align-items:center;font-weight:800;}
.res-sub{font-size:12px;color:var(--muted);font-weight:700;}
.bar{height:8px;border-radius:999px;background:rgba(255,255,255,.06);overflow:hidden;border:1px solid var(--stroke);}
.bar > div{height:100%;background:linear-gradient(90deg,var(--blue),var(--blue2));width:0%;}
.list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
@media (max-width:720px){.list{grid-template-columns:1fr;}}
.item{
  border:1px solid var(--stroke);border-radius:12px;padding:10px;background:linear-gradient(180deg,var(--card),var(--card2));
  display:flex;flex-direction:column;gap:6px;min-height:110px;
}
.item h4{margin:0;font-size:14px;font-weight:900;}
.item .desc{font-size:12px;color:var(--muted);font-weight:700;}
.cost{font-size:12px;font-weight:800;color:var(--text);}
.req{font-size:12px;color:var(--muted);}
.buybtn{
  margin-top:auto;padding:8px 10px;border-radius:10px;border:1px solid var(--stroke2);
  background:linear-gradient(180deg,var(--blue) 0%,var(--blue2) 100%);color:white;font-weight:900;font-size:12px;cursor:pointer;
}
.buybtn:disabled{opacity:.5;cursor:not-allowed;}
.note{font-size:12px;color:var(--muted);margin-top:6px;}
.hidden{display:none!important;}
#benchConvert,.res-card select,#benchConvert input,#benchConvert button{color:var(--text);}
#benchConvert select,#benchConvert input{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--stroke);}
</style>
</head>
<body>
<div id="rpgGate" class="gate hidden">
  <div class="gate-card">
    <div class="gate-title">üîí –î–æ—Å—Ç—É–ø –∫ RPG</div>
    <div class="gate-text">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.</div>
    <input id="gateInput" class="gate-input" type="password" placeholder="–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞">
    <button id="gateBtn" class="gate-btn">–í–æ–π—Ç–∏</button>
    <div id="gateError" class="gate-error"></div>
  </div>
</div>
<div class="app" id="appRoot" aria-hidden="true">
  <header>
    <a class="back" href="/">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="title">
      <h1>RPG</h1>
      <span>–î–æ–±—ã—á–∞ + –∫—Ä–∞—Ñ—Ç + –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>
    </div>
    <div class="balance-pill"><span>ü™ô</span><span id="balanceValue">0</span></div>
  </header>

  <section class="section">
    <div class="tabs" id="mainTabs">
      <div class="tab active" data-tab="inventory">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</div>
      <div class="tab" data-tab="shop">üõí –ú–∞–≥–∞–∑–∏–Ω</div>
      <div class="tab" data-tab="bench">üõ†Ô∏è –í–µ—Ä—Å—Ç–∞–∫</div>
    </div>
  </section>

  <section class="section" id="gatherSection">
    <button class="bigbtn" id="gatherBtn">‚õèÔ∏è –î–æ–±—ã—Ç—å —Ä–µ—Å—É—Ä—Å—ã</button>
    <div class="note" id="cdNote">–ö–î: 5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É –¥–æ–±—ã—á–∞–º–∏. –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —É–º–µ–Ω—å—à–∞—é—Ç –ö–î.</div>
  </section>

  <section class="section" id="inventoryView">
    <h3 style="margin:0 0 8px;font-size:16px;font-weight:900;">–†–µ—Å—É—Ä—Å—ã</h3>
    <div class="grid2" id="resGrid"></div>
  </section>

  <section class="section hidden" id="shopView">
    <h3 style="margin:0 0 8px;font-size:16px;font-weight:900;">–ú–∞–≥–∞–∑–∏–Ω</h3>
    <div class="tabs" id="shopTabs">
      <div class="tab active" data-shop="tools">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
      <div class="tab" data-shop="acc">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</div>
      <div class="tab" data-shop="bags">–°—É–º–∫–∏</div>
    </div>
    <div class="list" id="shopList" style="margin-top:10px;"></div>
    <div class="note">–ü–æ–∫—É–ø–∫–∞ —Å—Ä–∞–∑—É –ø—Ä–∏–º–µ–Ω—è–µ—Ç –±–∞—Ñ—Ñ, –ø—Ä–µ–¥–º–µ—Ç –ø—Ä–æ–ø–∞–¥–∞–µ—Ç –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞.</div>
  </section>

  <section class="section hidden" id="benchView">
    <h3 style="margin:0 0 8px;font-size:16px;font-weight:900;">–í–µ—Ä—Å—Ç–∞–∫</h3>
    <div class="tabs" id="benchTabs">
      <div class="tab active" data-bench="tools">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
      <div class="tab" data-bench="acc">–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</div>
      <div class="tab" data-bench="bags">–°—É–º–∫–∏</div>
      <div class="tab" data-bench="convert">–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</div>
    </div>

    <div id="benchTools" style="margin-top:10px;" class="list"></div>
    <div id="benchAcc" style="margin-top:10px;" class="list hidden"></div>
    <div id="benchBags" style="margin-top:10px;" class="list hidden"></div>

    <div id="benchConvert" class="hidden" style="margin-top:10px;">
      <div class="res-card" style="gap:8px;">
        <div style="font-weight:900;">–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤</div>
        <div class="res-sub">5 –º–µ–Ω–µ–µ —Ä–µ–¥–∫–∏—Ö ‚Üí 1 –±–æ–ª–µ–µ —Ä–µ–¥–∫–∏–π. –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –æ–±–º–µ–Ω—è—Ç—å –Ω–∞ ü™ô.</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <select id="convFrom" class="tab" style="font-weight:800;"></select>
          <select id="convTo" class="tab" style="font-weight:800;"></select>
          <input id="convAmount" type="number" min="1" value="1" class="tab" style="width:90px;text-align:center;">
          <button id="convBtn" class="tab" style="background:linear-gradient(180deg,var(--blue),var(--blue2));color:white;border-color:var(--stroke2);">–°–¥–µ–ª–∞—Ç—å</button>
        </div>
        <div class="note" id="convNote"></div>
      </div>
    </div>
  </section>

</div>

<script>
const tgInstance = initTelegramGuard();

const ACCESS_CODE = "admin";
const ACCESS_KEY = "rpg_access_ok";

const gateEl = document.getElementById("rpgGate");
const gateInput = document.getElementById("gateInput");
const gateBtn = document.getElementById("gateBtn");
const gateError = document.getElementById("gateError");
const appRoot = document.getElementById("appRoot");

function showGate(){
  gateEl.classList.remove("hidden");
  appRoot.setAttribute("aria-hidden", "true");
  setTimeout(()=>gateInput?.focus(), 50);
}

function grantAccess(){
  localStorage.setItem(ACCESS_KEY, "1");
  gateEl.classList.add("hidden");
  gateError.textContent = "";
  appRoot.removeAttribute("aria-hidden");
}

function checkGate(){
  const saved = localStorage.getItem(ACCESS_KEY);
  if(saved === "1"){
    grantAccess();
    return;
  }
  showGate();
}

gateBtn?.addEventListener("click", ()=>{
  const val = (gateInput?.value || "").trim();
  if(val !== ACCESS_CODE){
    gateError.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥";
    return;
  }
  grantAccess();
});

gateInput?.addEventListener("keydown", (e)=>{
  if(e.key === "Enter"){
    gateBtn?.click();
  }
});

checkGate();

const RES_MAX = 999;

const RES_META = [
  {id:"wood", name:"–î–µ—Ä–µ–≤–æ", icon:"ü™µ"},
  {id:"stone", name:"–ö–∞–º–µ–Ω—å", icon:"ü™®"},
  {id:"iron", name:"–ñ–µ–ª–µ–∑–æ", icon:"‚õìÔ∏è"},
  {id:"silver", name:"–°–µ—Ä–µ–±—Ä–æ", icon:"ü•à"},
  {id:"gold", name:"–ó–æ–ª–æ—Ç–æ", icon:"ü•á"},
  {id:"crystal", name:"–ö—Ä–∏—Å—Ç–∞–ª–ª", icon:"üíé"},
];

const ACCESSORIES = [
  {id:"acc1", name:"–¢–∞–ª–∏—Å–º–∞–Ω —É–¥–∞—á–∏", cost:3, cdRed:0.05, yieldAdd:0.05, req:{wood:10}},
  {id:"acc2", name:"–ö–æ–ª—å—Ü–æ —à–∞—Ö—Ç—ë—Ä–∞", cost:5, cdRed:0.08, yieldAdd:0.07, req:{stone:12}},
  {id:"acc3", name:"–ê–º—É–ª–µ—Ç –≤—Ä–µ–º–µ–Ω–∏", cost:8, cdRed:0.10, yieldAdd:0.06, req:{iron:8}},
  {id:"acc4", name:"–ë—Ä–∞—Å–ª–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏", cost:12, cdRed:0.12, yieldAdd:0.08, req:{silver:6}},
  {id:"acc5", name:"–ü–µ—á–∞—Ç—å —Å—Ç–∞—Ä–∞—Ç–µ–ª—è", cost:16, cdRed:0.15, yieldAdd:0.10, req:{gold:4}},
  {id:"acc6", name:"–ü–æ–¥–≤–µ—Å–∫–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–∞", cost:22, cdRed:0.18, yieldAdd:0.12, req:{crystal:2}},
  {id:"acc7", name:"–°–µ—Ä–¥—Ü–µ –ª–µ—Å–∞", cost:7, cdRed:0.06, yieldAdd:0.09, req:{wood:25,stone:10}},
  {id:"acc8", name:"–û–∫–æ –≥–æ—Ä—ã", cost:11, cdRed:0.09, yieldAdd:0.11, req:{stone:25,iron:5}},
  {id:"acc9", name:"–ó–≤–µ–∑–¥–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤", cost:18, cdRed:0.13, yieldAdd:0.14, req:{iron:15,silver:8}},
  {id:"acc10", name:"–ö–æ—Ä–æ–Ω–∞ —Å—Ç–∞—Ä–∞—Ç–µ–ª—è", cost:30, cdRed:0.20, yieldAdd:0.20, req:{silver:12,gold:8,crystal:3}},
];

const TOOLS = [
  {id:"tool1", name:"–ö–∏—Ä–∫–∞ –Ω–æ–≤–∏—á–∫–∞", cost:2, cdRed:0.00, yieldAdd:0.05, req:{wood:5}},
  {id:"tool2", name:"–ö–∞–º–µ–Ω–Ω–∞—è –∫–∏—Ä–∫–∞", cost:4, cdRed:0.04, yieldAdd:0.07, req:{wood:10,stone:10}},
  {id:"tool3", name:"–ñ–µ–ª–µ–∑–Ω–∞—è –∫–∏—Ä–∫–∞", cost:7, cdRed:0.06, yieldAdd:0.10, req:{stone:15,iron:6}},
  {id:"tool4", name:"–°–µ—Ä–µ–±—Ä—è–Ω–∞—è –∫–∏—Ä–∫–∞", cost:10, cdRed:0.08, yieldAdd:0.12, req:{iron:10,silver:4}},
  {id:"tool5", name:"–ó–æ–ª–æ—Ç–∞—è –∫–∏—Ä–∫–∞", cost:14, cdRed:0.10, yieldAdd:0.15, req:{silver:8,gold:3}},
  {id:"tool6", name:"–ö—Ä–∏—Å—Ç–∞–ª—å–Ω–∞—è –∫–∏—Ä–∫–∞", cost:20, cdRed:0.12, yieldAdd:0.18, req:{gold:6,crystal:2}},
  {id:"tool7", name:"–ë—É—Ä–æ–≤–æ–π –º–æ–ª–æ—Ç", cost:24, cdRed:0.15, yieldAdd:0.20, req:{iron:20,silver:10}},
  {id:"tool8", name:"–†–µ–∑–∞–∫ —Ä—É–¥—ã", cost:28, cdRed:0.18, yieldAdd:0.22, req:{silver:15,gold:8,crystal:2}},
];

const BAGS = [
  {id:"bag1",  name:"–ú–µ—à–æ–∫ –∏–∑ —Ç–∫–∞–Ω–∏",         cost:3,  capAdd:50,  req:{wood:8}},
  {id:"bag2",  name:"–°—É–º–∫–∞ —Å—Ç–∞—Ä–∞—Ç–µ–ª—è",        cost:6,  capAdd:100, req:{stone:12}},
  {id:"bag3",  name:"–†—é–∫–∑–∞–∫ —à–∞—Ö—Ç—ë—Ä–∞",         cost:12, capAdd:200, req:{iron:10,silver:4}},
  {id:"bag4",  name:"–£–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ä—é–∫–∑–∞–∫",     cost:18, capAdd:300, req:{iron:15, silver:5}},
  {id:"bag5",  name:"–≠–∫—Å–ø–µ–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –º–µ—à–æ–∫",  cost:25, capAdd:450, req:{silver:8, gold:3}},
  {id:"bag6",  name:"–ö–∞—Ä–∫–∞—Å–Ω–∞—è —Å—É–º–∫–∞",       cost:33, capAdd:650, req:{gold:5, crystal:1}},
  {id:"bag7",  name:"–ì–æ—Ä–Ω—ã–π –±–∞—É–ª",           cost:42, capAdd:900, req:{iron:25, silver:10, gold:6}},
  {id:"bag8",  name:"–°—É–º–∫–∞ –∏–Ω–∂–µ–Ω–µ—Ä–∞",        cost:55, capAdd:1200,req:{silver:18, gold:10, crystal:2}},
  {id:"bag9",  name:"–ê—Ä—Ç–µ—Ñ–∞–∫—Ç–Ω—ã–π —Ä—é–∫–∑–∞–∫",    cost:70, capAdd:1600,req:{gold:18, crystal:4}},
  {id:"bag10", name:"–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä", cost:95, capAdd:2200,req:{silver:25, gold:20, crystal:8}},
];

let uid = null;
let state = null;

function getTgUserId(){
  try{ return tg?.initDataUnsafe?.user?.id || null; }catch(e){ return null; }
}

try{
  uid = new URLSearchParams(location.search).get("uid") || getTgUserId();
}catch(e){
  uid = getTgUserId();
}

function setBalance(v){ document.getElementById("balanceValue").textContent = v||0; }

async function loadBalanceOnly(){
  let path = '/api/balance';
  if(uid) path += `?user_id=${uid}`;
  const r = await apiGet(path);
  if(r && (r.balance!=null)){
    setBalance(r.balance);
    state.balance = r.balance;
    localStorage.setItem('balance_local', r.balance);
  } else {
    const cached = localStorage.getItem('balance_local');
    if(cached!==null) setBalance(Number(cached)||0);
  }
}

function renderResources(){
  const grid=document.getElementById("resGrid");
  grid.innerHTML="";
  const caps = state.caps || {};
  RES_META.forEach(meta=>{
    const cur = state.resources?.[meta.id] ?? 0;
    const max = Math.min(RES_MAX + (caps[meta.id]||0), 5000);
    const pct = max>0 ? Math.min(100, (cur/max)*100) : 0;
    const el=document.createElement("div");
    el.className="res-card";
    el.innerHTML=`
      <div class="res-row"><span>${meta.icon} ${meta.name}</span><span>${cur}/${max}</span></div>
      <div class="bar"><div style="width:${pct}%"></div></div>
      <div class="res-sub">–ö–∞–ø: ${max}</div>
    `;
    grid.appendChild(el);
  });
}

function hasReq(req){
  for(const k in req){
    if((state.resources?.[k]||0) < req[k]) return false;
  }
  return true;
}
function reqText(req){
  return Object.entries(req).map(([k,v])=>{
    const name = RES_META.find(x=>x.id===k)?.name || k;
    return `${name}: ${v}`;
  }).join(", ");
}

function renderItemsInto(container, items, ownedSet, kind){
  container.innerHTML="";
  items.forEach(it=>{
    const owned = ownedSet.has(it.id);
    const enoughReq = hasReq(it.req||{});
    const costOk = (state.balance||0) >= it.cost;
    const canBuy = !owned && enoughReq && costOk;

    const buffs = [];
    if(it.cdRed) buffs.push(`–ö–î ‚àí${Math.round(it.cdRed*100)}%`);
    if(it.yieldAdd) buffs.push(`–î–æ–±—ã—á–∞ +${Math.round(it.yieldAdd*100)}%`);
    if(it.capAdd) buffs.push(`–ö–∞–ø +${it.capAdd}`);

    const el=document.createElement("div");
    el.className="item";
    el.innerHTML=`
      <h4>${it.name}</h4>
      <div class="desc">${buffs.join(" ‚Ä¢ ")}</div>
      <div class="cost">–¶–µ–Ω–∞: ü™ô ${it.cost}</div>
      <div class="req">–†–µ—Å—É—Ä—Å—ã: ${reqText(it.req||{})}</div>
      <button class="buybtn" ${canBuy?"":"disabled"}>
        ${owned?"–ö—É–ø–ª–µ–Ω–æ":"–ö—É–ø–∏—Ç—å"}
      </button>
    `;
    const btn = el.querySelector("button");
    if(canBuy){
      btn.addEventListener("click", async ()=>{
        const res = await apiPost("/api/rpg/buy", {user_id:uid, category:kind, item_id:it.id});
        if(!res.ok){ alert(res.error||"–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏"); return; }
        state = res.state;
        localStorage.setItem("rpg_state_"+uid, JSON.stringify(state));
        renderAll();
      });
    }
    container.appendChild(el);
  });
}

function renderShop(listKind){
  const ownedTools = new Set(state.owned?.tools||[]);
  const ownedAcc = new Set(state.owned?.acc||[]);
  const ownedBags = new Set(state.owned?.bags||[]);

  const list=document.getElementById("shopList");
  if(listKind==="tools") renderItemsInto(list, TOOLS, ownedTools, "tools");
  else if(listKind==="acc") renderItemsInto(list, ACCESSORIES, ownedAcc, "acc");
  else if(listKind==="bags") renderItemsInto(list, BAGS, ownedBags, "bags");
  else renderItemsInto(list, TOOLS, ownedTools, "tools");
}

function renderBench(){
  const ownedTools = new Set(state.owned?.tools||[]);
  const ownedAcc = new Set(state.owned?.acc||[]);
  const ownedBags = new Set(state.owned?.bags||[]);

  renderItemsInto(document.getElementById("benchTools"), TOOLS, ownedTools, "tools");
  renderItemsInto(document.getElementById("benchAcc"), ACCESSORIES, ownedAcc, "acc");
  renderItemsInto(document.getElementById("benchBags"), BAGS, ownedBags, "bags");
}

function renderCooldown(){
  const btn=document.getElementById("gatherBtn");
  const note=document.getElementById("cdNote");
  const now = Math.floor(Date.now()/1000);
  const rem = Math.max(0, Math.floor((state.cooldown_until||0) - now));
  state.cooldown_remaining = rem;
  if(rem<=0){
    btn.disabled=false;
    btn.textContent="‚õèÔ∏è –î–æ–±—ã—Ç—å —Ä–µ—Å—É—Ä—Å—ã";
    note.textContent="–ö–î: 5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É –¥–æ–±—ã—á–∞–º–∏. –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã/–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —É–º–µ–Ω—å—à–∞—é—Ç –ö–î.";
  } else {
    btn.disabled=true;
    const m=Math.floor(rem/60), s=rem%60;
    btn.textContent=`‚è≥ –ü–æ–¥–æ–∂–¥–∏ ${m}:${String(s).padStart(2,"0")}`;
    note.textContent=`–°–ª–µ–¥—É—é—â–∞—è –¥–æ–±—ã—á–∞ —á–µ—Ä–µ–∑ ${m} –º–∏–Ω ${s} —Å–µ–∫.`;
  }
}

function renderAll(){
  setBalance(state.balance);
  renderResources();
  renderBench();
  const activeShopTab = document.querySelector("#shopTabs .tab.active")?.dataset.shop || "tools";
  renderShop(activeShopTab);
  renderCooldown();
  fillConvertSelects();
}

function fillConvertSelects(){
  const fromSel=document.getElementById("convFrom");
  const toSel=document.getElementById("convTo");
  if(!fromSel || !toSel) return;
  if(fromSel.options.length===0){
    RES_META.forEach(r=>{
      const o=document.createElement("option"); o.value=r.id; o.textContent=r.name; fromSel.appendChild(o);
    });
    const pointsOpt=document.createElement("option"); pointsOpt.value="points"; pointsOpt.textContent="ü™ô –ë–∞–ª–∞–Ω—Å"; toSel.appendChild(pointsOpt);
    RES_META.slice(1).forEach(r=>{
      const o=document.createElement("option"); o.value=r.id; o.textContent=r.name; toSel.appendChild(o);
    });
  }
}

async function loadState(){
  const res = await apiGet(`/api/rpg/state?user_id=${uid}`);
  if(res && res.ok){
    state = res.state;
    if(!state.cooldown_until){
      state.cooldown_until = Math.floor(Date.now()/1000) + (state.cooldown_remaining||0);
    }
    localStorage.setItem("rpg_state_"+uid, JSON.stringify(state));
  } else {
    try{ state = JSON.parse(localStorage.getItem("rpg_state_"+uid) || "null"); }catch(e){ state=null; }
    if(!state){
      state = {
        balance: 0,
        resources: Object.fromEntries(RES_META.map(r=>[r.id,0])),
        owned:{tools:[],acc:[],bags:[]},
        cooldown_remaining: 0,
        cooldown_until: 0,
        buffs:{cd_mult:1, yield_add:0},
        caps:{wood:0,stone:0,iron:0,silver:0,gold:0,crystal:0}
      };
    }
    if(!state.cooldown_until){
      state.cooldown_until = Math.floor(Date.now()/1000) + (state.cooldown_remaining||0);
    }
  }
  await loadBalanceOnly();
  renderAll();
}

async function gather(){
  const res = await apiPost("/api/rpg/gather", {user_id:uid});
  if(res && res.ok){
    state = res.state;
    localStorage.setItem("rpg_state_"+uid, JSON.stringify(state));
    const gain=res.gained||{};
    const lines=Object.entries(gain).filter(([k,v])=>v>0).map(([k,v])=>{
      const name=RES_META.find(x=>x.id===k)?.name||k;
      return `${name}: +${v}`;
    });
    if(lines.length) alert("–î–æ–±—ã—Ç–æ:\n"+lines.join("\n"));
  } else {
    if(res && res.error === "cooldown"){
      const cd = Math.max(0, res.cooldown_remaining||0);
      state.cooldown_until = Math.floor(Date.now()/1000) + cd;
      state.cooldown_remaining = cd;
      localStorage.setItem("rpg_state_"+uid, JSON.stringify(state));
      renderCooldown();
      return;
    }
    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±—ã—Ç—å —Ä–µ—Å—É—Ä—Å—ã. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.");
    await loadState();
    return;
  }
  renderAll();
}

function setupTabs(){
  document.querySelectorAll("#mainTabs .tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll("#mainTabs .tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const tab=t.dataset.tab;
      document.getElementById("inventoryView").classList.toggle("hidden", tab!=="inventory");
      document.getElementById("shopView").classList.toggle("hidden", tab!=="shop");
      document.getElementById("benchView").classList.toggle("hidden", tab!=="bench");
    });
  });

  document.querySelectorAll("#shopTabs .tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll("#shopTabs .tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      renderShop(t.dataset.shop);
    });
  });

  document.querySelectorAll("#benchTabs .tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll("#benchTabs .tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const k=t.dataset.bench;
      document.getElementById("benchTools").classList.toggle("hidden", k!=="tools");
      document.getElementById("benchAcc").classList.toggle("hidden", k!=="acc");
      document.getElementById("benchBags").classList.toggle("hidden", k!=="bags");
      document.getElementById("benchConvert").classList.toggle("hidden", k!=="convert");
    });
  });
}

function setupConvert(){
  document.getElementById("convBtn").addEventListener("click", async ()=>{
    const from=document.getElementById("convFrom").value;
    const to=document.getElementById("convTo").value;
    const amt=Math.max(1, parseInt(document.getElementById("convAmount").value||"1",10));
    const res=await apiPost("/api/rpg/convert",{user_id:uid, from, to, amount:amt});
    if(!res.ok){ document.getElementById("convNote").textContent=res.error||"–û—à–∏–±–∫–∞"; return; }
    state=res.state;
    localStorage.setItem("rpg_state_"+uid, JSON.stringify(state));
    document.getElementById("convNote").textContent="–£—Å–ø–µ—à–Ω–æ!";
    renderAll();
  });
}

(async function main(){
  if(!tgInstance) return;
  await ensureNicknameOrRedirect(uid);
  setupTabs();
  setupConvert();
  document.getElementById("gatherBtn").addEventListener("click", gather);
  loadState();

  setInterval(()=>{
    if(state){
      renderCooldown();
      localStorage.setItem("rpg_state_"+uid, JSON.stringify(state));
    }
  },1000);
})();
</script>
</body>
</html>
