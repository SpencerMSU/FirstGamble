<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–∞–≥–∞–∑–∏–Ω ‚Äî FirstClub</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="/webapp_guard.js"></script>
<style>
:root{
  --bg:#0a0d12;--bg2:#0e1117;--panel:#0d1117;--card:#111722;--card2:#0f1520;
  --stroke:rgba(255,255,255,.06);--stroke2:rgba(100,160,255,.25);
  --blue:#3b82f6;--blue2:#1d4ed8;--text:#e6edf3;--muted:#98a2b3;
  --green:#22c55e;--red:#ef4444;--amber:#f59e0b;
  --shadow:0 0 0 1px var(--stroke),0 8px 30px rgba(0,0,0,.6);
  --radius:18px;
}
html[data-theme="light"]{
  --bg:#f4f7fb;--bg2:#eef2f7;--panel:#fff;--card:#fff;--card2:#f6f8fb;
  --stroke:rgba(10,20,40,.08);--stroke2:rgba(59,130,246,.35);
  --blue:#2563eb;--blue2:#1d4ed8;--text:#0b1220;--muted:#52607a;
  --shadow:0 0 0 1px var(--stroke),0 10px 26px rgba(10,20,40,.08);
} html,body{height:100%;overflow:hidden;overscroll-behavior:none;-webkit-overflow-scrolling:auto;touch-action:manipulation;} *{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
  background:
    radial-gradient(1000px 600px at 10% -10%, rgba(59,130,246,.28), transparent 60%),
    radial-gradient(800px 500px at 110% 0%, rgba(29,78,216,.22), transparent 55%),
    linear-gradient(180deg,var(--bg2) 0%,var(--bg) 100%);
  min-height:100vh;display:flex;justify-content:center;padding:16px;
}
.app{
  width:min(1000px,100%);
  border:1px solid var(--stroke);border-radius:20px;box-shadow:var(--shadow);padding:14px;
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
  height:100%;overflow-y:auto;overscroll-behavior:none;
}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px 14px;gap:10px;}
.title{display:flex;flex-direction:column;gap:2px;align-items:center;flex:1;}
.title h1{margin:0;font-size:20px;font-weight:800;}
.title span{font-size:12px;color:var(--muted);}
.back{
  display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  border:1px solid var(--stroke);color:var(--text);text-decoration:none;font-weight:700;font-size:14px;cursor:pointer;transition:.15s ease;
}
.back:hover{border-color:var(--stroke2);transform:translateY(-1px);}
.balance-pill{
  display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:999px;
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  border:1px solid var(--stroke);font-weight:800;font-size:14px;min-width:88px;justify-content:center;
}
.section{background:linear-gradient(180deg,var(--panel),transparent);border:1px solid var(--stroke);border-radius:var(--radius);padding:12px;margin-bottom:12px;}
.tabs{display:flex;gap:8px;flex-wrap:wrap;}
.tab{
  padding:7px 10px;border-radius:10px;border:1px solid var(--stroke);
  background:linear-gradient(180deg,var(--card) 0%,var(--card2) 100%);
  font-weight:800;font-size:12px;cursor:pointer;user-select:none;transition:.15s;
}
.tab.active{border-color:var(--stroke2);box-shadow:0 0 0 2px rgba(59,130,246,.12) inset;}
.bigbtn{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke2);cursor:pointer;
  background:linear-gradient(180deg,var(--blue) 0%,var(--blue2) 100%);color:white;font-weight:900;font-size:15px;
  display:flex;align-items:center;justify-content:center;gap:8px;transition:.15s;
}
.bigbtn:disabled{opacity:.6;cursor:not-allowed;filter:saturate(.5);}
.grid2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
@media (max-width:720px){.grid2{grid-template-columns:1fr;}}
.res-card{
  border:1px solid var(--stroke);border-radius:12px;padding:10px;background:linear-gradient(180deg,var(--card),var(--card2));
  display:flex;flex-direction:column;gap:6px;
}
.res-row{display:flex;justify-content:space-between;align-items:center;font-weight:800;}
.res-sub{font-size:12px;color:var(--muted);font-weight:700;}
.bar{height:8px;border-radius:999px;background:rgba(255,255,255,.06);overflow:hidden;border:1px solid var(--stroke);}
.bar > div{height:100%;background:linear-gradient(90deg,var(--blue),var(--blue2));width:0%;}
.list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
@media (max-width:720px){.list{grid-template-columns:1fr;}}
.item{
  border:1px solid var(--stroke);border-radius:12px;padding:10px;background:linear-gradient(180deg,var(--card),var(--card2));
  display:flex;flex-direction:column;gap:6px;min-height:110px;
}
.item h4{margin:0;font-size:14px;font-weight:900;}
.item .desc{font-size:12px;color:var(--muted);font-weight:700;}
.cost{font-size:12px;font-weight:800;color:var(--text);}
.req{font-size:12px;color:var(--muted);}
.buybtn{
  margin-top:auto;padding:8px 10px;border-radius:10px;border:1px solid var(--stroke2);
  background:linear-gradient(180deg,var(--blue) 0%,var(--blue2) 100%);color:white;font-weight:900;font-size:12px;cursor:pointer;
}
.buybtn:disabled{opacity:.5;cursor:not-allowed;}
.note{font-size:12px;color:var(--muted);margin-top:6px;}
.hidden{display:none!important;}
.container,.content{height:100%;overflow-y:auto;overscroll-behavior:none;}</style>
</head>
<body>
<div class="app">
  <header>
    <a class="back" href="/">‚Üê –ù–∞–∑–∞–¥</a>
    <div class="title">
      <h1>–ú–∞–≥–∞–∑–∏–Ω</h1>
      <span>–ü–æ–∫—É–ø–∞–π —Ç–æ–≤–∞—Ä—ã –∑–∞ –æ—á–∫–∏</span>
    </div>
    <div class="balance-pill"><span>ü™ô</span><span id="balanceValue">0</span></div>
  </header>

  <section class="section" id="goodsView">
    <div class="list" id="goodsList"></div>
    <div class="note">–ë–∏–ª–µ—Ç—ã –∑–∞–∫—Ä–µ–ø–ª—è—é—Ç—Å—è –∑–∞ —Ç–≤–æ–∏–º Telegram ID –∏ —É—á–∞—Å—Ç–≤—É—é—Ç –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–∞—Ö.</div>
  </section>
</div>

<script>

const tgInstance = initTelegramGuard();

let uid = null;

function getTgUserId(){
  try{ return tg?.initDataUnsafe?.user?.id || null; }catch(e){ return null; }
}

try{
  uid = new URLSearchParams(location.search).get("uid") || getTgUserId();
}catch(e){
  uid = getTgUserId();
}

let balance = 0;

const GOODS = [
  // –ó–∞–≥–ª—É—à–∫–∏ –ø–æ–¥ –±—É–¥—É—â–∏–µ —Ç–æ–≤–∞—Ä—ã
  {
    id:"soon1",
    name:"–°–∫–æ—Ä–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞",
    desc:"–î–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–µ –ø—Ä–∏–∑—ã –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –≤–µ—â–∏. –°–ª–µ–¥–∏ –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏!",
    cost:0,
    disabled:true
  },
];

  const TICKETS = [
    {
      id:"raffle_ticket",
      name:"üéü –ë–∏–ª–µ—Ç —Ä–æ–∑—ã–≥—Ä—ã—à–∞",
      cost:500,
      desc:"–ö–∞–∂–¥—ã–π –±–∏–ª–µ—Ç —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –±–ª–∏–∂–∞–π—à–µ–º —Ä–æ–∑—ã–≥—Ä—ã—à–µ –≥–ª–∞–≤–Ω–æ–≥–æ –ø—Ä–∏–∑–∞."
    }
  ];

function setBalance(v){
  balance = v||0;
  document.getElementById("balanceValue").textContent = balance;
}

function renderGoods(){
  const list = document.getElementById("goodsList");
  list.innerHTML = "";

  // Render Tickets
  TICKETS.forEach(t=>{
    const canBuy = balance >= t.cost;
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <h4>${t.name}</h4>
      <div class="desc">${t.desc}</div>
      <div class="cost">–¶–µ–Ω–∞: ü™ô ${t.cost}</div>
      <div class="req">–ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –±–∏–ª–µ—Ç –ø–æ—è–≤–∏—Ç—Å—è –≤ –õ–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.</div>
      <button class="buybtn" ${canBuy?"":"disabled"}>–ö—É–ø–∏—Ç—å</button>
    `;
    el.querySelector("button").addEventListener("click", ()=>buyTicket(t.cost));
    list.appendChild(el);
  });

  // Render other goods
  GOODS.forEach(g=>{
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML = `
      <h4>${g.name}</h4>
      <div class="desc">${g.desc}</div>
      <div class="cost">${g.cost>0?`–¶–µ–Ω–∞: ü™ô ${g.cost}`:""}</div>
      <button class="buybtn" disabled>–°–∫–æ—Ä–æ –≤ –ø—Ä–æ–¥–∞–∂–µ</button>
    `;
    list.appendChild(el);
  });
}

async function buyTicket(price){
  if(balance < price) return;
  const res = await apiPost("/api/raffle/buy_ticket", {user_id: uid});
  if(!res.ok){
    tg?.showAlert(res.error || "–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏ –±–∏–ª–µ—Ç–∞");
    return;
  }
  setBalance(res.balance);
  const bought = res.bought || res.ticket || (res.tickets?.slice(-1)?.[0]);
  tg?.showPopup?.({message: `–ö—É–ø–ª–µ–Ω –±–∏–ª–µ—Ç #${bought}`});
  renderGoods();
}

async function loadBalance(){
  let path = '/api/balance';
  if(uid) path += `?user_id=${uid}`;
  const r = await apiGet(path);
  if(r && r.ok){
    setBalance(r.balance);
    localStorage.setItem('balance_local', r.balance);
    renderGoods();
  } else {
    const cached = localStorage.getItem('balance_local');
    if(cached!==null){
      setBalance(Number(cached)||0);
      renderGoods();
    }
  }
}

(async function main(){
  if(!tgInstance) return;
  await ensureNicknameOrRedirect(uid);
  renderGoods();
  if(uid) loadBalance();
})();
</script>
</body>
</html>
